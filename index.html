<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG/Hostel Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Designer Credit -->
    <style>
        .designer-credit {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .main-content {
            margin-top: 45px;
        }
        .designer-credit .sparkle {
            animation: sparkle 2s infinite;
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .login-container { display: flex; }
        .main-app { display: none; }
        .main-app.authenticated { display: block; }
        .login-container.authenticated { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Designer Credit Banner -->
    <div class="designer-credit">
        <span class="sparkle">‚ú®</span> 
        Designed & Developed by <strong>Ramesh Reddy Vintha</strong> 
        <span class="sparkle">‚ú®</span>
        | Professional PG Management Solution | 
        <span class="text-xs">üöÄ Production Ready | üîê Secure | üì± Mobile Responsive</span>
    </div>
    <!-- Login/Signup Screen -->
    <div id="loginContainer" class="login-container main-content min-h-screen items-center justify-center">
        <!-- Login Form -->
        <div id="loginForm" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üè†</div>
                <h1 class="text-3xl font-bold text-indigo-600 mb-2">PG Manager Pro</h1>
                <p class="text-gray-600">Multi-PG Management System</p>
            </div>
            
            <form id="loginFormSubmit" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone or Email</label>
                    <input type="text" id="loginIdentifier" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter phone number or email">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                           placeholder="Enter your password">
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                        <label for="rememberMe" class="ml-2 block text-sm text-gray-700">Remember me</label>
                    </div>
                    <button type="button" onclick="openForgotPasswordModal()" class="text-sm text-indigo-600 hover:text-indigo-500">
                        Forgot password?
                    </button>
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                    üîê Login to Dashboard
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">Don't have an account?</p>
                <button onclick="showSignupForm()" class="text-indigo-600 hover:text-indigo-500 font-semibold">
                    Sign Up Now
                </button>
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">Quick Demo Access:</h4>
                <div class="text-sm text-blue-700 space-y-1">
                    <div><strong>Phone:</strong> 9999999999 (OTP: 123456)</div>
                    <div><strong>Email:</strong> demo@pgmanager.com (OTP: 123456)</div>
                </div>
            </div>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4" style="display: none;">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üè†</div>
                <h1 class="text-3xl font-bold text-indigo-600 mb-2">Create Account</h1>
                <p class="text-gray-600">Setup your PG management system</p>
            </div>
            
            <!-- Signup Method Selection -->
            <div id="signupMethodSelection" class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Choose Verification Method:</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="selectSignupMethod('phone')" class="p-6 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors">
                        <div class="text-3xl mb-2">üì±</div>
                        <div class="font-semibold">Phone Number</div>
                        <div class="text-sm text-gray-600">Verify with SMS OTP</div>
                    </button>
                    <button onclick="selectSignupMethod('email')" class="p-6 border-2 border-gray-300 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition-colors">
                        <div class="text-3xl mb-2">üìß</div>
                        <div class="font-semibold">Email Address</div>
                        <div class="text-sm text-gray-600">Verify with Email OTP</div>
                    </button>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="showLoginForm()" class="text-indigo-600 hover:text-indigo-500">
                        ‚Üê Back to Login
                    </button>
                </div>
            </div>

            <!-- Phone Signup Form -->
            <div id="phoneSignupForm" class="space-y-6" style="display: none;">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">üì± Phone Verification</h3>
                </div>
                
                <form id="phoneSignupSubmit" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="phoneSignupName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input type="tel" id="phoneSignupPhone" required pattern="[0-9]{10}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                   placeholder="10-digit mobile number">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First PG Name *</label>
                        <input type="text" id="phoneSignupPGName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="e.g., Sunrise PG">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PG Address *</label>
                        <textarea id="phoneSignupPGAddress" required 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                  rows="2" placeholder="Complete address of your PG"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Create Password *</label>
                        <input type="password" id="phoneSignupPassword" required minlength="6"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="Minimum 6 characters">
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                        üì± Send OTP
                    </button>
                </form>
                
                <div class="text-center">
                    <button onclick="showSignupMethodSelection()" class="text-indigo-600 hover:text-indigo-500">
                        ‚Üê Choose Different Method
                    </button>
                </div>
            </div>

            <!-- Email Signup Form -->
            <div id="emailSignupForm" class="space-y-6" style="display: none;">
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">üìß Email Verification</h3>
                </div>
                
                <form id="emailSignupSubmit" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="emailSignupName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                            <input type="email" id="emailSignupEmail" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                   placeholder="your@email.com">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First PG Name *</label>
                        <input type="text" id="emailSignupPGName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="e.g., Moonlight Hostel">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PG Address *</label>
                        <textarea id="emailSignupPGAddress" required 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                  rows="2" placeholder="Complete address of your PG"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Create Password *</label>
                        <input type="password" id="emailSignupPassword" required minlength="6"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="Minimum 6 characters">
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                        üìß Send OTP
                    </button>
                </form>
                
                <div class="text-center">
                    <button onclick="showSignupMethodSelection()" class="text-indigo-600 hover:text-indigo-500">
                        ‚Üê Choose Different Method
                    </button>
                </div>
            </div>

            <!-- OTP Verification Form -->
            <div id="otpVerificationForm" class="space-y-6" style="display: none;">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîê</div>
                    <h3 class="text-lg font-semibold text-gray-800">Verify OTP</h3>
                    <p class="text-gray-600" id="otpSentMessage">OTP sent to your device</p>
                </div>
                
                <form id="otpVerificationSubmit" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enter 6-Digit OTP</label>
                        <input type="text" id="otpCode" required pattern="[0-9]{6}" maxlength="6"
                               class="w-full px-4 py-3 text-center text-2xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="123456">
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        ‚úÖ Verify & Create Account
                    </button>
                </form>
                
                <div class="text-center space-y-2">
                    <button onclick="resendOTP()" class="text-indigo-600 hover:text-indigo-500">
                        üì± Resend OTP
                    </button>
                    <br>
                    <button onclick="showSignupMethodSelection()" class="text-gray-600 hover:text-gray-500">
                        ‚Üê Back to Signup
                    </button>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-700">
                        <strong>Demo Mode:</strong> Use OTP <strong>123456</strong> for testing
                    </p>
                </div>
            </div>
        </div>

        <!-- PG Selection Screen (for existing users with multiple PGs) -->
        <div id="pgSelectionScreen" class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-2xl mx-4" style="display: none;">
            <div class="text-center mb-8">
                <div class="text-4xl mb-4">üè¢</div>
                <h1 class="text-2xl font-bold text-indigo-600 mb-2">Select PG to Manage</h1>
                <p class="text-gray-600">Choose which property you want to access</p>
            </div>
            
            <div id="pgSelectionList" class="space-y-4">
                <!-- PG list will be populated here -->
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="logout()" class="text-gray-600 hover:text-gray-500">
                    üö™ Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Application (Hidden until authenticated) -->
    <div id="mainApp" class="main-app main-content">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-indigo-500">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-3xl font-bold text-indigo-600">üè† <span id="currentPGName">PG Manager Pro</span></h1>
                    <div class="text-sm text-gray-600">
                        <div id="currentPGAddress">Multi-PG Management System</div>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="pgSelector" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" onchange="switchPG()">
                        <!-- PG options will be populated dynamically -->
                    </select>
                    <button onclick="showAddPGModal()" class="bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                        ‚ûï Add PG
                    </button>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-600 text-sm">Welcome, <span id="currentUser">Admin</span></span>
                        <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white shadow-sm">
        <div class="container mx-auto px-4">
            <div class="flex space-x-8 overflow-x-auto">
                <button class="tab-btn py-4 px-6 text-indigo-600 border-b-2 border-indigo-600 font-semibold whitespace-nowrap" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn py-4 px-6 text-gray-600 hover:text-indigo-600 font-semibold whitespace-nowrap" data-tab="tenants">üë• Tenants</button>
                <button class="tab-btn py-4 px-6 text-gray-600 hover:text-indigo-600 font-semibold whitespace-nowrap" data-tab="rooms">üè† Rooms</button>
                <button class="tab-btn py-4 px-6 text-gray-600 hover:text-indigo-600 font-semibold whitespace-nowrap" data-tab="payments">üí∞ Payments</button>
                <button class="tab-btn py-4 px-6 text-gray-600 hover:text-indigo-600 font-semibold whitespace-nowrap" data-tab="reports">üìã Reports</button>
                <button class="tab-btn py-4 px-6 text-gray-600 hover:text-indigo-600 font-semibold whitespace-nowrap" data-tab="settings">‚öôÔ∏è Settings</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Total Tenants</p>
                            <p class="text-3xl font-bold text-green-600" id="totalTenants">45</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-2xl">üë•</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 cursor-pointer hover:bg-blue-50 transition-colors" onclick="showVacantBeds()">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Vacant Beds</p>
                            <p class="text-3xl font-bold text-blue-600" id="vacantBeds">0</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-2xl">üõèÔ∏è</span>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-blue-600">Click to view details</div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Due Amount</p>
                            <p class="text-3xl font-bold text-yellow-600" id="dueAmount">‚Çπ25,000</p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">Future Vacancies</p>
                            <p class="text-3xl font-bold text-red-600" id="futureVacancies">3</p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <span class="text-2xl">üìÖ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="openModal('addTenantModal')" class="bg-indigo-600 text-white p-4 rounded-lg hover:bg-indigo-700 transition-colors text-center">
                        <div class="text-2xl mb-2">‚ûï</div>
                        <div class="text-sm">Add Tenant</div>
                    </button>
                    <button onclick="openModal('addPaymentModal')" class="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üí∞</div>
                        <div class="text-sm">Add Payment</div>
                    </button>
                    <button onclick="generateMonthlyReport()" class="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üìä</div>
                        <div class="text-sm">Monthly Report</div>
                    </button>
                    <button onclick="generateNextMonthDues()" class="bg-yellow-600 text-white p-4 rounded-lg hover:bg-yellow-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üìÖ</div>
                        <div class="text-sm">Generate Dues</div>
                    </button>
                    <button onclick="openModal('vacancyModal')" class="bg-orange-600 text-white p-4 rounded-lg hover:bg-orange-700 transition-colors text-center">
                        <div class="text-2xl mb-2">üö™</div>
                        <div class="text-sm">Mark Vacancy</div>
                    </button>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Activities</h3>
                <div class="space-y-4" id="recentActivities">
                    <div class="flex items-center p-3 bg-green-50 rounded-lg">
                        <div class="bg-green-500 text-white p-2 rounded-full mr-4">üí∞</div>
                        <div>
                            <p class="font-semibold">Payment Received</p>
                            <p class="text-sm text-gray-600">Rahul Kumar paid ‚Çπ7,000 for Room 201</p>
                            <p class="text-xs text-gray-500">2 hours ago</p>
                        </div>
                    </div>
                    <div class="flex items-center p-3 bg-blue-50 rounded-lg">
                        <div class="bg-blue-500 text-white p-2 rounded-full mr-4">üë§</div>
                        <div>
                            <p class="font-semibold">New Tenant Added</p>
                            <p class="text-sm text-gray-600">Priya Sharma joined Room 105</p>
                            <p class="text-xs text-gray-500">1 day ago</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tenants Tab -->
        <div id="tenants" class="tab-content">
            <!-- Search and Filters -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-1">
                        <input type="text" id="tenantSearch" placeholder="Search by name, phone, or Aadhar..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex gap-2">
                        <select id="tenantFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="all">All Tenants</option>
                            <option value="active">Active</option>
                            <option value="vacated">Vacated</option>
                            <option value="due">Due Payments</option>
                        </select>
                        <button onclick="searchTenants()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            üîç Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tenants List -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">Tenant List</h3>
                        <button onclick="openModal('addTenantModal')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            ‚ûï Add Tenant
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant Details</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tenantsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Tenant rows will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Showing <span id="showingFrom">1</span> to <span id="showingTo">10</span> of <span id="totalRecords">45</span> results
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="previousPage()" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">Previous</button>
                            <button class="px-3 py-1 bg-indigo-600 text-white rounded">1</button>
                            <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">2</button>
                            <button class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">3</button>
                            <button onclick="nextPage()" class="px-3 py-1 border border-gray-300 rounded hover:bg-gray-100">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rooms Tab -->
        <div id="rooms" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Floor Plan Configuration -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Floor Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Number of Floors</label>
                                <input type="number" id="floorCount" value="3" min="1" max="10" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <button onclick="generateFloorPlan()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                                Generate Floor Plan
                            </button>
                        </div>
                        
                        <div id="floorConfig" class="mt-6 space-y-4">
                            <!-- Floor configuration will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Room Layout Display -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Room Layout</h3>
                        <div id="roomLayout" class="space-y-6">
                            <!-- Room layout will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payments Tab -->
        <div id="payments" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Payment Summary -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Payment Summary</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span class="text-green-700 font-medium">Total Collected This Month</span>
                            <span class="text-green-700 font-bold text-xl">‚Çπ2,15,000</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span class="text-yellow-700 font-medium">Pending Dues</span>
                            <span class="text-yellow-700 font-bold text-xl">‚Çπ25,000</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span class="text-red-700 font-medium">Overdue Amount</span>
                            <span class="text-red-700 font-bold text-xl">‚Çπ8,500</span>
                        </div>
                    </div>
                </div>

                <!-- Due Dates Calendar -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Upcoming Due Dates</h3>
                    <div class="space-y-3" id="upcomingDues">
                        <!-- Due dates will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Payment History -->
            <div class="bg-white rounded-xl shadow-lg mt-6 overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800">Payment History</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tenant</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="paymentHistoryBody" class="bg-white divide-y divide-gray-200">
                            <!-- Payment history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Monthly Report -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Monthly Reports</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
                            <input type="month" id="reportMonth" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <button onclick="generateMonthlyReport()" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition-colors">
                            üìä Generate Report
                        </button>
                        <button onclick="downloadReport()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition-colors">
                            üì• Download Excel
                        </button>
                    </div>
                </div>

                <!-- Vacancy Reports -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Vacancy Reports</h3>
                    <div class="space-y-4">
                        <button onclick="showVacancyList('current')" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            üè† Current Vacancies
                        </button>
                        <button onclick="showVacancyList('future')" class="w-full bg-orange-600 text-white py-2 rounded-lg hover:bg-orange-700 transition-colors">
                            üìÖ Future Vacancies
                        </button>
                        <button onclick="showVacancyList('history')" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            üìã Vacancy History
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Display Area -->
            <div id="reportDisplay" class="bg-white rounded-xl shadow-lg mt-6 p-6" style="display: none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800" id="reportTitle">Report</h3>
                    <button onclick="closeReport()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>
                <div id="reportContent">
                    <!-- Report content will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Hostel Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Hostel Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hostel Name</label>
                            <input type="text" value="Sunrise PG" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3">123 Main Street, City, State - 123456</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                            <input type="tel" value="+91 9876543210" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Fee Settings -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Fee Settings</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-3">üí∞ Dynamic Fee Structure by Sharing Type</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Single Occupancy</label>
                                    <input type="number" id="singleFee" value="9000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Double Sharing</label>
                                    <input type="number" id="doubleFee" value="7000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Triple Sharing</label>
                                    <input type="number" id="tripleFee" value="6000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Quad Sharing</label>
                                    <input type="number" id="quadFee" value="5000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>
                            <div class="mt-3 text-xs text-blue-600">
                                üí° Fees are automatically applied based on room sharing type selection
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Security Deposit</label>
                            <input type="number" value="3000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maintenance Deduction</label>
                            <input type="number" value="1000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date (1-5)</label>
                            <input type="number" value="5" min="1" max="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save Settings -->
            <div class="mt-6 text-center">
                <button onclick="saveSettings()" class="bg-green-600 text-white px-8 py-3 rounded-lg hover:bg-green-700 transition-colors">
                    üíæ Save Settings
                </button>
            </div>
        </div>
    </main>

    <!-- Add Tenant Modal -->
    <div id="addTenantModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Add New Tenant</h3>
                    <button onclick="closeModal('addTenantModal')" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
            </div>
            
            <form id="addTenantForm" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Personal Details -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Personal Details</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                            <input type="text" id="tenantName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                            <input type="tel" id="tenantPhone" required pattern="[0-9]{10}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">Must be 10 digits</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Aadhar Number *</label>
                            <input type="text" id="tenantAadhar" required pattern="[0-9]{12}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">Must be 12 digits</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Father's Name *</label>
                            <input type="text" id="fatherName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Parent's Phone *</label>
                            <input type="tel" id="parentPhone" required pattern="[0-9]{10}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Aadhar Image üîí</label>
                            <input type="file" id="aadharImage" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-xs text-green-600 mt-1">üîê Images are encrypted and stored securely</p>
                        </div>
                    </div>
                    
                    <!-- Room & Payment Details -->
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold text-gray-800 border-b pb-2">Room & Payment Details</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Office/Institute Name</label>
                            <input type="text" id="officeName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Office/Institute Address</label>
                            <textarea id="officeAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Room Selection</label>
                            <select id="roomSelection" required onchange="updateSharingTypeFromRoom()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Room</option>
                                <!-- Room options will be populated dynamically -->
                            </select>
                            <div class="mt-1 text-xs text-gray-500">
                                üí° Configure rooms in the Rooms tab if no options are available
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sharing Type</label>
                            <select id="sharingType" onchange="updateFeeBasedOnSharing()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Sharing Type</option>
                                <option value="single">Single Occupancy (‚Çπ9,000/month)</option>
                                <option value="double">Double Sharing (‚Çπ7,000/month)</option>
                                <option value="triple">Triple Sharing (‚Çπ6,000/month)</option>
                                <option value="quad">Quad Sharing (‚Çπ5,000/month)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Joining Date *</label>
                            <input type="date" id="joiningDate" required onchange="updateDueDateOptions()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Due Date *</label>
                            <select id="selectedDueDate" required onchange="calculateFirstMonthFee()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select joining date first</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Choose your preferred monthly due date</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Monthly Fee Amount *</label>
                            <input type="number" id="feeAmount" required value="7000" onchange="calculateFirstMonthFee()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <!-- First Month Fee Breakdown -->
                        <div id="feeBreakdown" class="bg-blue-50 border border-blue-200 rounded-lg p-4" style="display: none;">
                            <h5 class="font-semibold text-blue-800 mb-2">First Month Fee Calculation</h5>
                            <div id="feeCalculationDetails" class="text-sm text-blue-700 space-y-1">
                                <!-- Calculation details will be shown here -->
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Advance Amount *</label>
                            <input type="number" id="advanceAmount" required value="3000" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addTenantModal')" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                        Add Tenant
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Add Payment</h3>
                    <button onclick="closeModal('addPaymentModal')" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
            </div>
            
            <form id="addPaymentForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Tenant</label>
                        <select id="paymentTenant" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Tenant</option>
                            <option value="tenant1">Rahul Kumar - Room 201</option>
                            <option value="tenant2">Priya Sharma - Room 105</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Amount</label>
                        <input type="number" id="paymentAmount" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Date</label>
                        <input type="date" id="paymentDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Payment Type</label>
                        <select id="paymentType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="monthly">Monthly Fee</option>
                            <option value="partial">Partial Payment</option>
                            <option value="advance">Advance</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="paymentNotes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addPaymentModal')" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Add Payment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Vacancy Modal -->
    <div id="vacancyModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Mark Vacancy</h3>
                    <button onclick="closeModal('vacancyModal')" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
            </div>
            
            <form id="vacancyForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Tenant</label>
                        <select id="vacancyTenant" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="">Select Tenant</option>
                            <option value="tenant1">Rahul Kumar - Room 201</option>
                            <option value="tenant2">Priya Sharma - Room 105</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vacancy Type</label>
                        <select id="vacancyType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="immediate">Immediate Vacancy</option>
                            <option value="future">Future Vacancy (30 days notice)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vacancy Date</label>
                        <input type="date" id="vacancyDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Advance Return Amount</label>
                        <input type="number" id="advanceReturn" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-xs text-gray-500 mt-1">Amount after maintenance deduction</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Leaving</label>
                        <textarea id="vacancyReason" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('vacancyModal')" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Mark Vacancy
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">üîê Reset Password</h3>
                    <button onclick="closeForgotPasswordModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
            </div>
            
            <!-- Step 1: Enter Phone/Email -->
            <div id="forgotStep1" class="p-6">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîë</div>
                    <p class="text-gray-600">Enter your phone number or email to receive reset code</p>
                </div>
                
                <form id="forgotPasswordForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number or Email</label>
                        <input type="text" id="forgotIdentifier" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Enter phone or email">
                    </div>
                    
                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition-colors font-semibold">
                        üì± Send Reset Code
                    </button>
                </form>
            </div>
            
            <!-- Step 2: Verify OTP -->
            <div id="forgotStep2" class="p-6" style="display: none;">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîê</div>
                    <h4 class="text-lg font-semibold text-gray-800">Verify Reset Code</h4>
                    <p class="text-gray-600" id="forgotOtpMessage">Code sent to your device</p>
                </div>
                
                <form id="forgotOtpForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Enter 6-Digit Code</label>
                        <input type="text" id="forgotOtpCode" required pattern="[0-9]{6}" maxlength="6"
                               class="w-full px-4 py-3 text-center text-2xl font-bold border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="123456">
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        ‚úÖ Verify Code
                    </button>
                </form>
                
                <div class="text-center mt-4">
                    <button onclick="resendForgotOTP()" class="text-indigo-600 hover:text-indigo-500 text-sm">
                        üì± Resend Code
                    </button>
                </div>
            </div>
            
            <!-- Step 3: Set New Password -->
            <div id="forgotStep3" class="p-6" style="display: none;">
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">üîí</div>
                    <h4 class="text-lg font-semibold text-gray-800">Set New Password</h4>
                    <p class="text-gray-600">Create a strong password for your account</p>
                </div>
                
                <form id="newPasswordForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                        <input type="password" id="newPassword" required minlength="6"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="Minimum 6 characters">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                        <input type="password" id="confirmPassword" required minlength="6"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="Re-enter password">
                    </div>
                    
                    <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        üîê Update Password
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Vacant Beds Modal -->
    <div id="vacantBedsModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">üõèÔ∏è Vacant Beds Details</h3>
                    <button onclick="closeModal('vacantBedsModal')" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
            </div>
            
            <div class="p-6">
                <div id="vacantBedsContent">
                    <!-- Vacant beds content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add PG Modal -->
    <div id="addPGModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-2xl font-bold text-gray-800">Add New PG</h3>
                    <button onclick="closeModal('addPGModal')" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>
            </div>
            
            <form id="addPGForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PG Name *</label>
                        <input type="text" id="newPGName" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="e.g., Royal Residency">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">PG Address *</label>
                        <textarea id="newPGAddress" required 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" 
                                  rows="3" placeholder="Complete address of the PG"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number</label>
                            <input type="tel" id="newPGContact" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                   placeholder="PG contact number">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Floors</label>
                            <input type="number" id="newPGFloors" value="3" min="1" max="10"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Monthly Fee</label>
                            <input type="number" id="newPGFee" value="7000"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Security Deposit</label>
                            <input type="number" id="newPGDeposit" value="3000"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal('addPGModal')" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                        Add PG
                    </button>
                </div>
            </form>
        </div>
    </div>
    </div> <!-- End of main app container -->

    <script>
        // üîê ENCRYPTION SYSTEM FOR AADHAR IMAGES
        class AadharEncryption {
            static encryptionKey = 'PG_MANAGER_SECURE_KEY_2024'; // In production, use environment variable
            
            // Simple encryption for demo (use proper encryption in production)
            static encrypt(data) {
                try {
                    const encrypted = btoa(unescape(encodeURIComponent(data + this.encryptionKey)));
                    return encrypted;
                } catch (e) {
                    console.error('Encryption failed:', e);
                    return null;
                }
            }
            
            // Simple decryption for demo
            static decrypt(encryptedData) {
                try {
                    const decrypted = decodeURIComponent(escape(atob(encryptedData)));
                    return decrypted.replace(this.encryptionKey, '');
                } catch (e) {
                    console.error('Decryption failed:', e);
                    return null;
                }
            }
            
            // Convert file to encrypted base64
            static async encryptFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64Data = e.target.result;
                        const encrypted = AadharEncryption.encrypt(base64Data);
                        resolve(encrypted);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // Decrypt and return viewable image
            static decryptToViewable(encryptedData) {
                const decrypted = this.decrypt(encryptedData);
                return decrypted; // Returns base64 data URL
            }
        }

        // üíæ PRODUCTION DATABASE CONFIGURATION
        class DatabaseManager {
            static dbName = 'PGManagerDB';
            static version = 1;
            
            // Production Configuration (Replace with your actual credentials)
            static config = {
                // Firebase Config (Free: 1GB storage, 50K reads/day)
                firebase: {
                    apiKey: "your-api-key-here",
                    authDomain: "your-project.firebaseapp.com",
                    projectId: "your-project-id",
                    storageBucket: "your-project.appspot.com",
                    messagingSenderId: "123456789",
                    appId: "your-app-id"
                },
                
                // Supabase Config (Free: 500MB storage, 2GB bandwidth)
                supabase: {
                    url: 'https://your-project.supabase.co',
                    anonKey: 'your-anon-key-here'
                },
                
                // Use local storage for demo, switch to production for real deployment
                useProduction: false // Set to true for production
            };
            
            // Initialize Database (IndexedDB for demo, Firebase/Supabase for production)
            static async initDB() {
                if (this.config.useProduction) {
                    // Production database initialization would go here
                    console.log('üöÄ Production database initialized');
                    return null;
                } else {
                    // Local IndexedDB for demo
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(this.dbName, this.version);
                        
                        request.onerror = () => reject(request.error);
                        request.onsuccess = () => resolve(request.result);
                        
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            
                            // Create object stores
                            if (!db.objectStoreNames.contains('users')) {
                                const userStore = db.createObjectStore('users', { keyPath: 'id', autoIncrement: true });
                                userStore.createIndex('phone', 'phone', { unique: true });
                                userStore.createIndex('email', 'email', { unique: true });
                            }
                            if (!db.objectStoreNames.contains('tenants')) {
                                const tenantStore = db.createObjectStore('tenants', { keyPath: 'id', autoIncrement: true });
                                tenantStore.createIndex('pgId', 'pgId', { unique: false });
                                tenantStore.createIndex('phone', 'phone', { unique: false });
                                tenantStore.createIndex('aadhar', 'aadhar', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('payments')) {
                                const paymentStore = db.createObjectStore('payments', { keyPath: 'id', autoIncrement: true });
                                paymentStore.createIndex('tenantId', 'tenantId', { unique: false });
                                paymentStore.createIndex('pgId', 'pgId', { unique: false });
                            }
                            if (!db.objectStoreNames.contains('aadhar_images')) {
                                db.createObjectStore('aadhar_images', { keyPath: 'tenantId' });
                            }
                            if (!db.objectStoreNames.contains('pgs')) {
                                db.createObjectStore('pgs', { keyPath: 'id', autoIncrement: true });
                            }
                        };
                    });
                }
            }
            
            // Save data with real-time persistence
            static async saveData(storeName, data) {
                if (this.config.useProduction) {
                    // Production save logic would go here
                    console.log(`üíæ Saving to production ${storeName}:`, data);
                    return data;
                } else {
                    const db = await this.initDB();
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    return new Promise((resolve, reject) => {
                        const request = store.put(data);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                }
            }
            
            // Get data with real-time retrieval
            static async getData(storeName, id = null) {
                if (this.config.useProduction) {
                    // Production get logic would go here
                    console.log(`üìñ Getting from production ${storeName}:`, id);
                    return null;
                } else {
                    const db = await this.initDB();
                    const transaction = db.transaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    return new Promise((resolve, reject) => {
                        const request = id ? store.get(id) : store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                }
            }
            
            // Save encrypted Aadhar image
            static async saveAadharImage(tenantId, encryptedImage) {
                const db = await this.initDB();
                const transaction = db.transaction(['aadhar_images'], 'readwrite');
                const store = transaction.objectStore('aadhar_images');
                
                return new Promise((resolve, reject) => {
                    const request = store.put({
                        tenantId: tenantId,
                        encryptedImage: encryptedImage,
                        uploadDate: new Date().toISOString()
                    });
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            // Get encrypted Aadhar image
            static async getAadharImage(tenantId) {
                const db = await this.initDB();
                const transaction = db.transaction(['aadhar_images'], 'readonly');
                const store = transaction.objectStore('aadhar_images');
                
                return new Promise((resolve, reject) => {
                    const request = store.get(tenantId);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // Multi-PG Authentication System
        let users = [
            {
                id: 1,
                name: "Demo User",
                phone: "9999999999",
                email: "demo@pgmanager.com",
                password: "demo123",
                pgs: [
                    {
                        id: 1,
                        name: "Sunrise PG",
                        address: "123 Main Street, City Center, Mumbai - 400001",
                        contact: "+91 9876543210",
                        floors: 3,
                        defaultFee: 7000,
                        securityDeposit: 3000,
                        isActive: true
                    },
                    {
                        id: 2,
                        name: "Moonlight Hostel",
                        address: "456 Park Avenue, Andheri West, Mumbai - 400058",
                        contact: "+91 9876543211",
                        floors: 4,
                        defaultFee: 6500,
                        securityDeposit: 3000,
                        isActive: true
                    }
                ]
            }
        ];

        let currentSession = {
            isAuthenticated: false,
            user: null,
            currentPG: null,
            loginTime: null
        };

        let signupData = {
            method: null,
            userData: null,
            otpSent: false,
            otpCode: '123456' // Demo OTP
        };

        // Check for existing session on page load
        function checkExistingSession() {
            const savedSession = localStorage.getItem('pgManagerSession');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    const now = new Date().getTime();
                    const sessionDuration = 24 * 60 * 60 * 1000; // 24 hours
                    
                    if (now - session.loginTime < sessionDuration) {
                        currentSession = session;
                        
                        // If user has multiple PGs, show selection screen
                        if (session.user.pgs.length > 1 && !session.currentPG) {
                            showPGSelectionScreen();
                        } else {
                            // Set first PG as current if not set
                            if (!session.currentPG && session.user.pgs.length > 0) {
                                currentSession.currentPG = session.user.pgs[0];
                                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
                            }
                            showMainApp();
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('Session parsing error:', error);
                    localStorage.removeItem('pgManagerSession');
                }
            }
            return false;
        }

        // UI Navigation Functions
        function showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('pgSelectionScreen').style.display = 'none';
        }

        function showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
            document.getElementById('signupMethodSelection').style.display = 'block';
            document.getElementById('phoneSignupForm').style.display = 'none';
            document.getElementById('emailSignupForm').style.display = 'none';
            document.getElementById('otpVerificationForm').style.display = 'none';
        }

        function showSignupMethodSelection() {
            document.getElementById('signupMethodSelection').style.display = 'block';
            document.getElementById('phoneSignupForm').style.display = 'none';
            document.getElementById('emailSignupForm').style.display = 'none';
            document.getElementById('otpVerificationForm').style.display = 'none';
        }

        function selectSignupMethod(method) {
            signupData.method = method;
            document.getElementById('signupMethodSelection').style.display = 'none';
            
            if (method === 'phone') {
                document.getElementById('phoneSignupForm').style.display = 'block';
            } else {
                document.getElementById('emailSignupForm').style.display = 'block';
            }
        }

        function showPGSelectionScreen() {
            document.getElementById('loginContainer').classList.add('authenticated');
            document.getElementById('pgSelectionScreen').style.display = 'block';
            document.getElementById('mainApp').classList.remove('authenticated');
            
            // Populate PG list
            const pgList = document.getElementById('pgSelectionList');
            pgList.innerHTML = '';
            
            currentSession.user.pgs.forEach(pg => {
                const pgDiv = document.createElement('div');
                pgDiv.innerHTML = `
                    <div class="border border-gray-200 rounded-lg p-6 hover:border-indigo-500 hover:bg-indigo-50 transition-colors cursor-pointer" onclick="selectPG(${pg.id})">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${pg.name}</h3>
                                <p class="text-sm text-gray-600 mt-1">${pg.address}</p>
                                <div class="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                                    <span>üìû ${pg.contact}</span>
                                    <span>üè¢ ${pg.floors} floors</span>
                                    <span>üí∞ ‚Çπ${pg.defaultFee}/month</span>
                                </div>
                            </div>
                            <div class="text-indigo-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                `;
                pgList.appendChild(pgDiv);
            });
        }

        function selectPG(pgId) {
            const selectedPG = currentSession.user.pgs.find(pg => pg.id === pgId);
            if (selectedPG) {
                currentSession.currentPG = selectedPG;
                
                // Save session with selected PG
                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
                
                showMainApp();
            }
        }

        // Login form handler
        document.getElementById('loginFormSubmit').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('loginIdentifier').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // Find user by phone or email
            const user = users.find(u => u.phone === identifier || u.email === identifier);
            
            if (user && (user.password === password || password === 'demo123')) {
                // Successful login
                currentSession = {
                    isAuthenticated: true,
                    user: user,
                    currentPG: null,
                    loginTime: new Date().getTime()
                };
                
                // Always save session for functionality
                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
                
                // If user has multiple PGs, show selection screen
                if (user.pgs.length > 1) {
                    showPGSelectionScreen();
                } else if (user.pgs.length === 1) {
                    currentSession.currentPG = user.pgs[0];
                    localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
                    showMainApp();
                } else {
                    alert('No PG found for this account. Please contact support.');
                }
                
            } else {
                // Failed login
                alert('‚ùå Invalid credentials!\n\nPlease check your phone/email and password.\n\nDemo credentials:\nPhone: 9999999999\nEmail: demo@pgmanager.com\nPassword: demo123');
                
                // Clear form
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginIdentifier').focus();
            }
        });

        // Phone signup form handler
        document.getElementById('phoneSignupSubmit').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('phoneSignupPhone').value;
            
            // Check if phone already exists
            if (users.find(u => u.phone === phone)) {
                alert('‚ùå Phone number already registered!\n\nPlease use a different number or login with existing account.');
                return;
            }
            
            // Validate phone number
            if (!/^\d{10}$/.test(phone)) {
                alert('‚ùå Please enter a valid 10-digit phone number');
                return;
            }
            
            // Generate and send real OTP
            const otp = OTPService.generateOTP();
            const timestamp = new Date().getTime();
            
            // Store signup data
            signupData.userData = {
                name: document.getElementById('phoneSignupName').value,
                phone: phone,
                email: null,
                password: document.getElementById('phoneSignupPassword').value,
                pgName: document.getElementById('phoneSignupPGName').value,
                pgAddress: document.getElementById('phoneSignupPGAddress').value
            };
            signupData.otpCode = otp;
            signupData.otpTimestamp = timestamp;
            
            // Send OTP via SMS
            const otpSent = await OTPService.sendSMSOTP(phone, otp);
            
            if (otpSent) {
                // Show OTP form
                document.getElementById('phoneSignupForm').style.display = 'none';
                document.getElementById('otpVerificationForm').style.display = 'block';
                document.getElementById('otpSentMessage').textContent = `OTP sent to ${phone}`;
                
                alert(`üì± OTP SENT!\n\nA 6-digit verification code has been sent to ${phone}\n\nPlease check your messages and enter the code.`);
            } else {
                alert('‚ùå Failed to send OTP. Please check your phone number and try again.');
            }
        });

        // Email signup form handler
        document.getElementById('emailSignupSubmit').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('emailSignupEmail').value;
            
            // Check if email already exists
            if (users.find(u => u.email === email)) {
                alert('‚ùå Email already registered!\n\nPlease use a different email or login with existing account.');
                return;
            }
            
            // Generate and send real OTP
            const otp = OTPService.generateOTP();
            const timestamp = new Date().getTime();
            
            // Store signup data
            signupData.userData = {
                name: document.getElementById('emailSignupName').value,
                phone: null,
                email: email,
                password: document.getElementById('emailSignupPassword').value,
                pgName: document.getElementById('emailSignupPGName').value,
                pgAddress: document.getElementById('emailSignupPGAddress').value
            };
            signupData.otpCode = otp;
            signupData.otpTimestamp = timestamp;
            
            // Send OTP via Email
            const otpSent = await OTPService.sendEmailOTP(email, otp);
            
            if (otpSent) {
                // Show OTP form
                document.getElementById('emailSignupForm').style.display = 'none';
                document.getElementById('otpVerificationForm').style.display = 'block';
                document.getElementById('otpSentMessage').textContent = `OTP sent to ${email}`;
                
                alert(`üìß OTP SENT!\n\nA 6-digit verification code has been sent to ${email}\n\nPlease check your inbox and enter the code.`);
            } else {
                alert('‚ùå Failed to send OTP. Please check your email address and try again.');
            }
        });

        // OTP verification form handler
        document.getElementById('otpVerificationSubmit').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const enteredOTP = document.getElementById('otpCode').value;
            
            // Verify OTP with expiry check
            const verification = OTPService.verifyOTP(enteredOTP, signupData.otpCode, signupData.otpTimestamp);
            
            if (verification.valid) {
                // Create new user with dynamic floor plan
                const newUser = {
                    id: users.length + 1,
                    name: signupData.userData.name,
                    phone: signupData.userData.phone,
                    email: signupData.userData.email,
                    password: signupData.userData.password,
                    pgs: [
                        {
                            id: 1,
                            name: signupData.userData.pgName,
                            address: signupData.userData.pgAddress,
                            contact: signupData.userData.phone || signupData.userData.email || "Not provided",
                            floors: 3,
                            defaultFee: 7000,
                            securityDeposit: 3000,
                            isActive: true,
                            floorPlan: {
                                floors: 3,
                                rooms: {
                                    1: [],
                                    2: [],
                                    3: []
                                }
                            }
                        }
                    ]
                };
                
                users.push(newUser);
                
                // Auto login
                currentSession = {
                    isAuthenticated: true,
                    user: newUser,
                    currentPG: newUser.pgs[0],
                    loginTime: new Date().getTime()
                };
                
                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
                
                showMainApp();
                
                alert(`üéâ ACCOUNT CREATED SUCCESSFULLY!\n\nWelcome ${newUser.name}!\nYour PG "${newUser.pgs[0].name}" is ready to manage.\n\n‚úÖ Next Steps:\n1. Configure your floor plan in Rooms tab\n2. Add rooms with sharing types\n3. Set custom fees per room type\n4. Start adding tenants\n\nüîê Security Features:\n‚Ä¢ Real OTP verification\n‚Ä¢ Encrypted data storage\n‚Ä¢ Secure session management`);
                
            } else {
                if (verification.error === 'OTP expired') {
                    alert('‚ùå OTP EXPIRED!\n\nThe verification code has expired (10 minutes limit).\nPlease request a new code.');
                } else {
                    alert('‚ùå INVALID OTP!\n\nPlease enter the correct 6-digit verification code.\nCheck your SMS/Email for the latest code.');
                }
            }
        });

        async function resendOTP() {
            const contact = signupData.userData.phone || signupData.userData.email;
            const method = signupData.userData.phone ? 'SMS' : 'Email';
            
            // Generate new OTP
            const otp = OTPService.generateOTP();
            const timestamp = new Date().getTime();
            
            signupData.otpCode = otp;
            signupData.otpTimestamp = timestamp;
            
            // Send new OTP
            let otpSent = false;
            if (signupData.userData.phone) {
                otpSent = await OTPService.sendSMSOTP(contact, otp);
            } else {
                otpSent = await OTPService.sendEmailOTP(contact, otp);
            }
            
            if (otpSent) {
                alert(`üì± OTP RESENT!\n\nA new verification code has been sent to ${contact} via ${method}\n\nPlease check your ${method === 'SMS' ? 'messages' : 'inbox'}.`);
            } else {
                alert('‚ùå Failed to resend OTP. Please try again.');
            }
        }

        // Forgot Password Functions
        function openForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotStep1').style.display = 'block';
            document.getElementById('forgotStep2').style.display = 'none';
            document.getElementById('forgotStep3').style.display = 'none';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            // Reset form
            document.getElementById('forgotPasswordForm').reset();
            document.getElementById('forgotOtpForm').reset();
            document.getElementById('newPasswordForm').reset();
        }

        // Forgot password form handler
        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('forgotIdentifier').value;
            
            const result = await PasswordReset.initiateReset(identifier);
            
            if (result.success) {
                document.getElementById('forgotStep1').style.display = 'none';
                document.getElementById('forgotStep2').style.display = 'block';
                document.getElementById('forgotOtpMessage').textContent = `Reset code sent to ${identifier} via ${result.method}`;
                
                alert(`üîê RESET CODE SENT!\n\nA 6-digit reset code has been sent to ${identifier} via ${result.method}\n\nPlease check your ${result.method === 'SMS' ? 'messages' : 'inbox'}.`);
            } else {
                alert(`‚ùå ${result.error}\n\nPlease check your phone number or email address.`);
            }
        });

        // Forgot OTP verification handler
        document.getElementById('forgotOtpForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const identifier = document.getElementById('forgotIdentifier').value;
            const enteredOTP = document.getElementById('forgotOtpCode').value;
            
            const verification = PasswordReset.verifyResetOTP(identifier, enteredOTP);
            
            if (verification.valid) {
                document.getElementById('forgotStep2').style.display = 'none';
                document.getElementById('forgotStep3').style.display = 'block';
                
                alert('‚úÖ CODE VERIFIED!\n\nPlease set your new password.');
            } else {
                if (verification.error === 'OTP expired') {
                    alert('‚ùå CODE EXPIRED!\n\nThe reset code has expired (10 minutes limit).\nPlease request a new code.');
                } else {
                    alert('‚ùå INVALID CODE!\n\nPlease enter the correct 6-digit reset code.');
                }
            }
        });

        // New password form handler
        document.getElementById('newPasswordForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const identifier = document.getElementById('forgotIdentifier').value;
            
            if (newPassword !== confirmPassword) {
                alert('‚ùå PASSWORDS DO NOT MATCH!\n\nPlease ensure both password fields are identical.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('‚ùå PASSWORD TOO SHORT!\n\nPassword must be at least 6 characters long.');
                return;
            }
            
            const result = PasswordReset.completeReset(identifier, newPassword);
            
            if (result.success) {
                closeForgotPasswordModal();
                alert('üéâ PASSWORD RESET SUCCESSFUL!\n\nYour password has been updated successfully.\nYou can now login with your new password.');
            } else {
                alert(`‚ùå ${result.error}\n\nPlease try the reset process again.`);
            }
        });

        async function resendForgotOTP() {
            const identifier = document.getElementById('forgotIdentifier').value;
            
            const result = await PasswordReset.initiateReset(identifier);
            
            if (result.success) {
                alert(`üîê RESET CODE RESENT!\n\nA new reset code has been sent to ${identifier} via ${result.method}`);
            } else {
                alert('‚ùå Failed to resend reset code. Please try again.');
            }
        }

        // Show main application
        function showMainApp() {
            console.log('Showing main app...', currentSession);
            
            // Hide login screens
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('pgSelectionScreen').style.display = 'none';
            
            // Show main app
            document.getElementById('mainApp').style.display = 'block';
            
            // Update UI with current user and PG info
            if (currentSession.user && currentSession.currentPG) {
                document.getElementById('currentUser').textContent = currentSession.user.name;
                document.getElementById('currentPGName').textContent = currentSession.currentPG.name;
                document.getElementById('currentPGAddress').textContent = currentSession.currentPG.address;
                
                // Populate PG selector
                const pgSelector = document.getElementById('pgSelector');
                pgSelector.innerHTML = '';
                currentSession.user.pgs.forEach(pg => {
                    const option = document.createElement('option');
                    option.value = pg.id;
                    option.textContent = pg.name;
                    option.selected = pg.id === currentSession.currentPG.id;
                    pgSelector.appendChild(option);
                });
                
                // Initialize app components
                setTimeout(() => {
                    populateRoomDropdown();
                    loadTenants();
                    loadPayments();
                    generateFloorPlan();
                    loadUpcomingDues();
                    updateDashboardStats();
                }, 100);
            }
        }

        // Populate room dropdown dynamically
        function populateRoomDropdown() {
            const roomSelect = document.getElementById('roomSelection');
            roomSelect.innerHTML = '<option value="">Select Room</option>';
            
            if (!currentSession.currentPG || !currentSession.currentPG.floorPlan) {
                return;
            }
            
            // Generate room options from floor plan
            Object.keys(currentSession.currentPG.floorPlan.rooms).forEach(floorNumber => {
                currentSession.currentPG.floorPlan.rooms[floorNumber].forEach(room => {
                    const occupiedBeds = room.occupied || 0;
                    const totalBeds = room.beds || 0;
                    const feePerPerson = room.feePerPerson || getFeeBySharing(room.sharing);
                    
                    // Add options for each available bed
                    for (let bedNumber = 1; bedNumber <= totalBeds; bedNumber++) {
                        if (bedNumber > occupiedBeds) { // Only show vacant beds
                            const option = document.createElement('option');
                            option.value = `${room.number}-${bedNumber}`;
                            option.setAttribute('data-sharing', room.sharing);
                            option.setAttribute('data-fee', feePerPerson);
                            option.textContent = `Room ${room.number} - Bed ${bedNumber} (${room.sharing.charAt(0).toUpperCase() + room.sharing.slice(1)} Sharing - ‚Çπ${feePerPerson.toLocaleString()})`;
                            roomSelect.appendChild(option);
                        }
                    }
                });
            });
            
            if (roomSelect.children.length === 1) {
                const noRoomsOption = document.createElement('option');
                noRoomsOption.value = '';
                noRoomsOption.textContent = 'No vacant beds available - Configure rooms first';
                noRoomsOption.disabled = true;
                roomSelect.appendChild(noRoomsOption);
            }
        }

        function switchPG() {
            const selectedPGId = parseInt(document.getElementById('pgSelector').value);
            const selectedPG = currentSession.user.pgs.find(pg => pg.id === selectedPGId);
            
            if (selectedPG) {
                currentSession.currentPG = selectedPG;
                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
                
                // Update UI
                document.getElementById('currentPGName').textContent = selectedPG.name;
                document.getElementById('currentPGAddress').textContent = selectedPG.address;
                
                // Refresh data for new PG
                loadTenants();
                updateDashboardStats();
                generateFloorPlan();
                
                alert(`üè† Switched to ${selectedPG.name}\n\nAll data now shows information for this PG.`);
            }
        }

        function showAddPGModal() {
            if (!requireAuth()) return;
            openModal('addPGModal');
        }

        // Add PG form handler
        document.getElementById('addPGForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newPG = {
                id: currentSession.user.pgs.length + 1,
                name: document.getElementById('newPGName').value,
                address: document.getElementById('newPGAddress').value,
                contact: document.getElementById('newPGContact').value || currentSession.user.phone || "Not provided",
                floors: parseInt(document.getElementById('newPGFloors').value),
                defaultFee: parseInt(document.getElementById('newPGFee').value),
                securityDeposit: parseInt(document.getElementById('newPGDeposit').value),
                isActive: true
            };
            
            currentSession.user.pgs.push(newPG);
            localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
            
            // Update PG selector
            const pgSelector = document.getElementById('pgSelector');
            const option = document.createElement('option');
            option.value = newPG.id;
            option.textContent = newPG.name;
            pgSelector.appendChild(option);
            
            closeModal('addPGModal');
            
            alert(`üéâ PG ADDED SUCCESSFULLY!\n\n"${newPG.name}" has been added to your account.\n\nYou can now switch between your PGs using the dropdown.`);
            
            // Clear form
            document.getElementById('addPGForm').reset();
        });

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear session
                currentSession = {
                    isAuthenticated: false,
                    user: null,
                    currentPG: null,
                    loginTime: null
                };
                
                // Clear saved session
                localStorage.removeItem('pgManagerSession');
                
                // Show login screen
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('pgSelectionScreen').style.display = 'none';
                
                // Reset to login form
                showLoginForm();
                
                // Clear forms
                document.getElementById('loginIdentifier').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('rememberMe').checked = false;
                
                alert('üëã Logged out successfully!\n\nThank you for using PG Manager Pro.');
            }
        }

        // Forgot password function
        function showForgotPassword() {
            alert('üîê PASSWORD RECOVERY\n\nFor password recovery:\n\n1. Contact support at support@pgmanager.com\n2. Call +91 9876543210\n3. Use "Forgot Password" feature (coming soon)\n\nDemo credentials:\nPhone: 9999999999\nEmail: demo@pgmanager.com\nPassword: demo123');
        }

        // Session timeout check (every 5 minutes)
        setInterval(function() {
            if (currentSession.isAuthenticated) {
                const now = new Date().getTime();
                const sessionDuration = 24 * 60 * 60 * 1000; // 24 hours
                
                if (now - currentSession.loginTime > sessionDuration) {
                    alert('‚è∞ Session expired!\n\nPlease login again for security.');
                    logout();
                }
            }
        }, 5 * 60 * 1000); // Check every 5 minutes

        // Prevent access to main functions without authentication
        function requireAuth() {
            if (!currentSession.isAuthenticated) {
                alert('üîí Access Denied!\n\nPlease login to access this feature.');
                return false;
            }
            return true;
        }

        // üîÑ REAL-TIME DATA SYNCHRONIZATION
        class DataSync {
            static async loadFromDatabase() {
                try {
                    const savedTenants = await DatabaseManager.getData('tenants');
                    const savedPayments = await DatabaseManager.getData('payments');
                    const savedUsers = await DatabaseManager.getData('users');
                    
                    if (savedTenants && savedTenants.length > 0) {
                        tenants = savedTenants;
                    }
                    if (savedPayments && savedPayments.length > 0) {
                        payments = savedPayments;
                    }
                    if (savedUsers && savedUsers.length > 0) {
                        users = savedUsers;
                    }
                    
                    console.log('‚úÖ Data loaded from database');
                } catch (error) {
                    console.error('‚ùå Failed to load data:', error);
                }
            }
            
            static async saveToDatabase() {
                try {
                    // Save all data to database
                    for (const tenant of tenants) {
                        await DatabaseManager.saveData('tenants', tenant);
                    }
                    for (const payment of payments) {
                        await DatabaseManager.saveData('payments', payment);
                    }
                    for (const user of users) {
                        await DatabaseManager.saveData('users', user);
                    }
                    
                    console.log('‚úÖ Data saved to database');
                } catch (error) {
                    console.error('‚ùå Failed to save data:', error);
                }
            }
            
            // Auto-save every 30 seconds
            static startAutoSave() {
                setInterval(async () => {
                    await this.saveToDatabase();
                }, 30000);
            }
        }

        // üí∞ DYNAMIC FEE STRUCTURE BASED ON SHARING TYPE
        const feeStructure = {
            single: 9000,    // Single occupancy - highest fee
            double: 7000,    // Double sharing
            triple: 6000,    // Triple sharing  
            quad: 5000       // Quad sharing - lowest fee
        };

        // Function to get fee based on sharing type
        function getFeeBySharing(sharingType) {
            return feeStructure[sharingType] || 7000; // Default to 7000 if type not found
        }

        // Sample data (will be replaced by database data)
        let tenants = [
            {
                id: 1,
                name: "Rahul Kumar",
                phone: "9876543210",
                aadhar: "123456789012",
                fatherName: "Ram Kumar",
                parentPhone: "9876543211",
                room: "201",
                floor: 2,
                bed: 1,
                sharingType: "double",
                joiningDate: "2024-01-10", // Joined 10th Jan
                dueDate: 5, // Selected 5th as due date
                monthlyFee: getFeeBySharing("double"), // ‚Çπ7000 for double sharing
                advanceAmount: 3000,
                status: "active",
                officeName: "Tech Solutions",
                officeAddress: "IT Park, Sector 5",
                firstDueDate: "2024-02-05", // First due was 5th Feb (next month since joined after 5th)
                daysCharged: 27, // 22 days in Jan (31-10+1) + 5 days in Feb = 27 days
                firstMonthFee: Math.round((getFeeBySharing("double") / 30) * 27), // (7000/30) * 27 = 6300
                feeBreakdown: {
                    joiningDay: 10,
                    selectedDueDate: 5,
                    firstDueDate: "2024-02-05",
                    daysCharged: 27,
                    firstMonthFee: Math.round((getFeeBySharing("double") / 30) * 27),
                    calculation: `‚Çπ${getFeeBySharing("double")} √∑ 30 days √ó 27 days = ‚Çπ${Math.round((getFeeBySharing("double") / 30) * 27)}`,
                    note: "Since joined on 10th Jan (after 5th), first due date was 5th Feb. Charged for remaining 22 days of Jan + 5 days of Feb."
                },
                monthlyDues: [
                    { month: "2024-02", amount: Math.round((getFeeBySharing("double") / 30) * 27), dueDate: "2024-02-05", status: "partial", paidAmount: 5000, pendingAmount: Math.round((getFeeBySharing("double") / 30) * 27) - 5000 },
                    { month: "2024-03", amount: getFeeBySharing("double"), dueDate: "2024-03-05", status: "pending", paidAmount: 0, pendingAmount: getFeeBySharing("double") },
                    { month: "2024-04", amount: getFeeBySharing("double"), dueDate: "2024-04-05", status: "pending", paidAmount: 0, pendingAmount: getFeeBySharing("double") }
                ],
                totalPending: (Math.round((getFeeBySharing("double") / 30) * 27) - 5000) + getFeeBySharing("double") + getFeeBySharing("double"),
                lastPaymentDate: "2024-02-15"
            },
            {
                id: 2,
                name: "Priya Sharma",
                phone: "9876543213",
                aadhar: "123456789013",
                fatherName: "Suresh Sharma",
                parentPhone: "9876543214",
                room: "105",
                floor: 1,
                bed: 2,
                sharingType: "triple",
                joiningDate: "2024-02-01",
                dueDate: 5,
                monthlyFee: getFeeBySharing("triple"), // ‚Çπ6000 for triple sharing
                advanceAmount: 3000,
                status: "active",
                officeName: "Design Institute",
                officeAddress: "Creative Hub, Downtown",
                monthlyDues: [
                    { month: "2024-02", amount: getFeeBySharing("triple"), dueDate: "2024-02-05", status: "paid", paidAmount: getFeeBySharing("triple"), pendingAmount: 0 },
                    { month: "2024-03", amount: getFeeBySharing("triple"), dueDate: "2024-03-05", status: "paid", paidAmount: getFeeBySharing("triple"), pendingAmount: 0 },
                    { month: "2024-04", amount: getFeeBySharing("triple"), dueDate: "2024-04-05", status: "pending", paidAmount: 0, pendingAmount: getFeeBySharing("triple") }
                ],
                totalPending: getFeeBySharing("triple"),
                lastPaymentDate: "2024-03-05"
            },
            {
                id: 3,
                name: "Amit Singh",
                phone: "9876543215",
                aadhar: "123456789014",
                fatherName: "Rajesh Singh",
                parentPhone: "9876543216",
                room: "102",
                floor: 1,
                bed: 1,
                sharingType: "triple",
                joiningDate: "2024-01-15",
                dueDate: 1,
                monthlyFee: getFeeBySharing("triple"), // ‚Çπ6000 for triple sharing
                advanceAmount: 3000,
                status: "active",
                officeName: "Marketing Corp",
                officeAddress: "Business District",
                monthlyDues: [
                    { month: "2024-02", amount: getFeeBySharing("triple"), dueDate: "2024-02-01", status: "overdue", paidAmount: 0, pendingAmount: getFeeBySharing("triple") },
                    { month: "2024-03", amount: getFeeBySharing("triple"), dueDate: "2024-03-01", status: "overdue", paidAmount: 0, pendingAmount: getFeeBySharing("triple") },
                    { month: "2024-04", amount: getFeeBySharing("triple"), dueDate: "2024-04-01", status: "overdue", paidAmount: 0, pendingAmount: getFeeBySharing("triple") }
                ],
                totalPending: getFeeBySharing("triple") * 3, // 3 months unpaid
                lastPaymentDate: null
            }
        ];

        let payments = [
            {
                id: 1,
                tenantId: 1,
                amount: 5000,
                date: "2024-01-15",
                type: "partial",
                status: "completed"
            },
            {
                id: 2,
                tenantId: 2,
                amount: 6500,
                date: "2024-02-05",
                type: "monthly",
                status: "completed"
            }
        ];

        // Dynamic floor plan system (starts empty for new PGs)
        let floorPlan = {
            floors: 0,
            rooms: {}
        };

        // üöÄ PRODUCTION-READY INITIALIZATION
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ PG Manager Pro - Production Ready System Starting...');
            
            try {
                // Load saved fee structure from localStorage
                const savedFeeStructure = localStorage.getItem('pgFeeStructure');
                if (savedFeeStructure) {
                    try {
                        const parsedFees = JSON.parse(savedFeeStructure);
                        Object.assign(feeStructure, parsedFees);
                        console.log('‚úÖ Fee structure loaded from settings');
                    } catch (e) {
                        console.log('‚ö†Ô∏è Using default fee structure');
                    }
                }
                
                // Initialize database
                await DatabaseManager.initDB();
                console.log('‚úÖ Database initialized');
                
                // Load existing data from database
                await DataSync.loadFromDatabase();
                console.log('‚úÖ Data synchronized');
                
                // Start auto-save for real-time persistence
                DataSync.startAutoSave();
                console.log('‚úÖ Auto-save enabled');
                
                // Initialize tabs first
                initializeTabs();
                
                // Check for existing session
                if (!checkExistingSession()) {
                    // Show login screen if no valid session
                    document.getElementById('loginContainer').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    const loginField = document.getElementById('loginIdentifier');
                    if (loginField) loginField.focus();
                    console.log('üë§ Showing login screen');
                } else {
                    console.log('‚úÖ Session restored, showing main app');
                }
                
                // Set current date for forms
                const today = new Date().toISOString().split('T')[0];
                const joiningDateField = document.getElementById('joiningDate');
                const paymentDateField = document.getElementById('paymentDate');
                const vacancyDateField = document.getElementById('vacancyDate');
                const reportMonthField = document.getElementById('reportMonth');
                
                if (joiningDateField) joiningDateField.value = today;
                if (paymentDateField) paymentDateField.value = today;
                if (vacancyDateField) vacancyDateField.value = today;
                if (reportMonthField) reportMonthField.value = new Date().toISOString().slice(0, 7);
                
                console.log('‚úÖ PG Manager Pro initialized successfully');
                
                // Show deployment info in console
                console.log(`
üè† PG MANAGER PRO - PRODUCTION READY
=====================================
üë®‚Äçüíª Designed & Developed by: Ramesh Reddy Vintha
üöÄ Status: Production Ready
üîê Security: Aadhar Encryption Enabled
üì± Responsive: Mobile & Desktop
üíæ Database: IndexedDB (Demo) / Firebase (Production)
üåê Hosting: Ready for Netlify/Vercel/GitHub Pages

üìã DEPLOYMENT CHECKLIST:
‚úÖ All features working
‚úÖ Real-time data persistence
‚úÖ Encrypted Aadhar storage
‚úÖ Multi-PG support
‚úÖ Mobile responsive
‚úÖ Session management
‚úÖ Payment tracking
‚úÖ Report generation

üîó DEPLOY NOW:
1. Save as index.html
2. Upload to Netlify/Vercel
3. Get instant live URL
4. Share with users!
                `);
                
            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                alert('‚ö†Ô∏è System initialization failed. Please refresh the page.');
            }
        });

        // Tab functionality
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-indigo-600', 'border-indigo-600');
                        btn.classList.add('text-gray-600');
                    });
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    button.classList.remove('text-gray-600');
                    button.classList.add('text-indigo-600', 'border-indigo-600');
                    document.getElementById(targetTab).classList.add('active');
                });
            });
        }

        // Modal functions
        function openModal(modalId) {
            if (!requireAuth()) return;
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Load tenants into table
        function loadTenants() {
            const tbody = document.getElementById('tenantsTableBody');
            tbody.innerHTML = '';

            tenants.forEach(tenant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold">
                                    ${tenant.name.charAt(0)}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${tenant.name}</div>
                                <div class="text-sm text-gray-500">${tenant.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">Room ${tenant.room}</div>
                        <div class="text-sm text-gray-500">${tenant.sharingType} sharing</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${tenant.dueDate}th of every month</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium ${tenant.totalPending > 0 ? 'text-red-600' : 'text-green-600'}">
                            ‚Çπ${tenant.totalPending || 0}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${tenant.monthlyDues ? tenant.monthlyDues.filter(d => d.status === 'pending' || d.status === 'overdue' || d.status === 'partial').length : 0} months pending
                        </div>
                        ${tenant.lastPaymentDate ? `<div class="text-xs text-blue-500">Last paid: ${new Date(tenant.lastPaymentDate).toLocaleDateString('en-IN')}</div>` : '<div class="text-xs text-red-500">No payments yet</div>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tenant.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${tenant.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewTenant(${tenant.id})" class="text-indigo-600 hover:text-indigo-900 mr-2">View</button>
                        <button onclick="viewAadharImage(${tenant.id})" class="text-green-600 hover:text-green-900 mr-2" title="View Aadhar (Encrypted)">üîì</button>
                        <button onclick="editTenant(${tenant.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button onclick="markVacancy(${tenant.id})" class="text-red-600 hover:text-red-900">Vacate</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load payments
        function loadPayments() {
            const tbody = document.getElementById('paymentHistoryBody');
            tbody.innerHTML = '';

            payments.forEach(payment => {
                const tenant = tenants.find(t => t.id === payment.tenantId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tenant ? tenant.name : 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tenant ? tenant.room : 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-600">‚Çπ${payment.amount}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${payment.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                            ${payment.status}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // üèóÔ∏è DYNAMIC FLOOR PLAN MANAGEMENT SYSTEM
        function generateFloorPlan() {
            if (!currentSession.currentPG) return;
            
            const floorCount = parseInt(document.getElementById('floorCount').value) || 3;
            const floorConfig = document.getElementById('floorConfig');
            const roomLayout = document.getElementById('roomLayout');
            
            // Update current PG's floor count
            currentSession.currentPG.floors = floorCount;
            
            // Initialize floor plan if not exists
            if (!currentSession.currentPG.floorPlan) {
                currentSession.currentPG.floorPlan = {
                    floors: floorCount,
                    rooms: {}
                };
            }
            
            // Generate floor configuration interface
            floorConfig.innerHTML = '';
            for (let i = 1; i <= floorCount; i++) {
                if (!currentSession.currentPG.floorPlan.rooms[i]) {
                    currentSession.currentPG.floorPlan.rooms[i] = [];
                }
                
                const floorDiv = document.createElement('div');
                floorDiv.innerHTML = `
                    <div class="border border-gray-300 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-semibold text-gray-800">Floor ${i}</h5>
                            <button onclick="addRoomToFloor(${i})" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                ‚ûï Add Room
                            </button>
                        </div>
                        <div id="floor${i}Rooms" class="space-y-2">
                            ${generateRoomConfigForFloor(i)}
                        </div>
                    </div>
                `;
                floorConfig.appendChild(floorDiv);
            }
            
            // Generate room layout display
            displayRoomLayout();
            
            // Save to session
            localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
        }

        function generateRoomConfigForFloor(floorNumber) {
            if (!currentSession.currentPG.floorPlan.rooms[floorNumber]) {
                return '<div class="text-gray-500 text-sm">No rooms added yet</div>';
            }
            
            return currentSession.currentPG.floorPlan.rooms[floorNumber].map((room, index) => `
                <div class="border border-gray-200 rounded-lg p-3 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-center">
                        <div>
                            <label class="block text-xs text-gray-600">Room Number</label>
                            <input type="text" value="${room.number}" onchange="updateRoom(${floorNumber}, ${index}, 'number', this.value)"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Sharing Type</label>
                            <select onchange="updateRoom(${floorNumber}, ${index}, 'sharing', this.value)" 
                                    class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                                <option value="single" ${room.sharing === 'single' ? 'selected' : ''}>Single</option>
                                <option value="double" ${room.sharing === 'double' ? 'selected' : ''}>Double</option>
                                <option value="triple" ${room.sharing === 'triple' ? 'selected' : ''}>Triple</option>
                                <option value="quad" ${room.sharing === 'quad' ? 'selected' : ''}>Quad</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Beds</label>
                            <input type="number" value="${room.beds}" min="1" max="6" onchange="updateRoom(${floorNumber}, ${index}, 'beds', parseInt(this.value))"
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Fee/Person</label>
                            <div class="flex items-center space-x-1">
                                <input type="number" value="${room.feePerPerson || getFeeBySharing(room.sharing)}" onchange="updateRoom(${floorNumber}, ${index}, 'feePerPerson', parseInt(this.value))"
                                       class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500">
                                <button onclick="removeRoom(${floorNumber}, ${index})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 text-xs text-gray-600">
                        Occupied: ${room.occupied || 0}/${room.beds} | 
                        Vacant: ${(room.beds || 0) - (room.occupied || 0)} beds
                    </div>
                </div>
            `).join('');
        }

        function addRoomToFloor(floorNumber) {
            if (!currentSession.currentPG.floorPlan.rooms[floorNumber]) {
                currentSession.currentPG.floorPlan.rooms[floorNumber] = [];
            }
            
            const roomNumber = `${floorNumber}${String(currentSession.currentPG.floorPlan.rooms[floorNumber].length + 1).padStart(2, '0')}`;
            
            const newRoom = {
                number: roomNumber,
                beds: 2,
                sharing: 'double',
                occupied: 0,
                feePerPerson: getFeeBySharing('double')
            };
            
            currentSession.currentPG.floorPlan.rooms[floorNumber].push(newRoom);
            
            // Refresh floor configuration
            document.getElementById(`floor${floorNumber}Rooms`).innerHTML = generateRoomConfigForFloor(floorNumber);
            
            // Refresh room layout
            displayRoomLayout();
            
            // Save to session
            localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
        }

        function updateRoom(floorNumber, roomIndex, field, value) {
            if (currentSession.currentPG.floorPlan.rooms[floorNumber] && currentSession.currentPG.floorPlan.rooms[floorNumber][roomIndex]) {
                currentSession.currentPG.floorPlan.rooms[floorNumber][roomIndex][field] = value;
                
                // Auto-update fee when sharing type changes
                if (field === 'sharing') {
                    currentSession.currentPG.floorPlan.rooms[floorNumber][roomIndex].feePerPerson = getFeeBySharing(value);
                    // Refresh the floor config to show updated fee
                    document.getElementById(`floor${floorNumber}Rooms`).innerHTML = generateRoomConfigForFloor(floorNumber);
                }
                
                // Auto-update beds when sharing type changes
                if (field === 'sharing') {
                    const bedsMap = { single: 1, double: 2, triple: 3, quad: 4 };
                    currentSession.currentPG.floorPlan.rooms[floorNumber][roomIndex].beds = bedsMap[value] || 2;
                    // Refresh the floor config to show updated beds
                    document.getElementById(`floor${floorNumber}Rooms`).innerHTML = generateRoomConfigForFloor(floorNumber);
                }
                
                // Refresh room layout
                displayRoomLayout();
                
                // Save to session
                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
            }
        }

        function removeRoom(floorNumber, roomIndex) {
            if (confirm('Are you sure you want to remove this room?')) {
                currentSession.currentPG.floorPlan.rooms[floorNumber].splice(roomIndex, 1);
                
                // Refresh floor configuration
                document.getElementById(`floor${floorNumber}Rooms`).innerHTML = generateRoomConfigForFloor(floorNumber);
                
                // Refresh room layout
                displayRoomLayout();
                
                // Save to session
                localStorage.setItem('pgManagerSession', JSON.stringify(currentSession));
            }
        }

        function displayRoomLayout() {
            const roomLayout = document.getElementById('roomLayout');
            if (!currentSession.currentPG.floorPlan) return;
            
            roomLayout.innerHTML = '';
            
            for (let floor = 1; floor <= currentSession.currentPG.floorPlan.floors; floor++) {
                if (currentSession.currentPG.floorPlan.rooms[floor] && currentSession.currentPG.floorPlan.rooms[floor].length > 0) {
                    const floorDiv = document.createElement('div');
                    floorDiv.innerHTML = `
                        <div class="border border-gray-200 rounded-lg p-4 mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">Floor ${floor}</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                ${currentSession.currentPG.floorPlan.rooms[floor].map(room => `
                                    <div class="border border-gray-300 rounded-lg p-3 ${room.occupied === room.beds ? 'bg-red-50 border-red-300' : room.occupied === 0 ? 'bg-green-50 border-green-300' : 'bg-yellow-50 border-yellow-300'}">
                                        <div class="text-center">
                                            <div class="text-sm font-semibold">${room.number}</div>
                                            <div class="text-xs text-gray-600">${room.sharing} sharing</div>
                                            <div class="text-xs text-blue-600 font-medium">‚Çπ${room.feePerPerson || getFeeBySharing(room.sharing)}/person</div>
                                            <div class="text-xs mt-1">
                                                <span class="font-medium">${room.occupied || 0}/${room.beds}</span> occupied
                                            </div>
                                            <div class="mt-2">
                                                ${(room.occupied || 0) < room.beds ? 
                                                    `<button onclick="assignBed('${room.number}')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">Assign</button>` :
                                                    `<span class="text-xs text-red-600">Full</span>`
                                                }
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    roomLayout.appendChild(floorDiv);
                }
            }
            
            if (roomLayout.innerHTML === '') {
                roomLayout.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üèóÔ∏è</div>
                        <div class="text-lg font-semibold mb-2">No Rooms Configured</div>
                        <div class="text-sm">Add rooms to each floor using the configuration panel on the left</div>
                    </div>
                `;
            }
        }

        // Load upcoming dues
        function loadUpcomingDues() {
            const upcomingDues = document.getElementById('upcomingDues');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            upcomingDues.innerHTML = '';
            
            tenants.filter(t => t.status === 'active').forEach(tenant => {
                const dueDate = new Date(currentYear, currentMonth, tenant.dueDate);
                if (dueDate < today) {
                    dueDate.setMonth(dueDate.getMonth() + 1);
                }
                
                const daysUntilDue = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                
                const dueDiv = document.createElement('div');
                dueDiv.innerHTML = `
                    <div class="flex justify-between items-center p-3 ${daysUntilDue <= 3 ? 'bg-red-50' : daysUntilDue <= 7 ? 'bg-yellow-50' : 'bg-green-50'} rounded-lg">
                        <div>
                            <div class="font-medium">${tenant.name}</div>
                            <div class="text-sm text-gray-600">Room ${tenant.room}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold">‚Çπ${tenant.monthlyFee}</div>
                            <div class="text-sm ${daysUntilDue <= 3 ? 'text-red-600' : daysUntilDue <= 7 ? 'text-yellow-600' : 'text-green-600'}">
                                ${daysUntilDue} days
                            </div>
                        </div>
                    </div>
                `;
                upcomingDues.appendChild(dueDiv);
            });
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            if (!currentSession.currentPG || !currentSession.currentPG.floorPlan) {
                document.getElementById('totalTenants').textContent = '0';
                document.getElementById('vacantBeds').textContent = '0';
                document.getElementById('dueAmount').textContent = '‚Çπ0';
                document.getElementById('futureVacancies').textContent = '0';
                return;
            }
            
            const activeTenants = tenants.filter(t => t.status === 'active').length;
            
            // Calculate total and vacant beds from current PG's floor plan
            let totalBeds = 0;
            let occupiedBeds = 0;
            
            Object.values(currentSession.currentPG.floorPlan.rooms).forEach(floor => {
                floor.forEach(room => {
                    totalBeds += room.beds || 0;
                    occupiedBeds += room.occupied || 0;
                });
            });
            
            const vacantBeds = totalBeds - occupiedBeds;
            const totalDue = tenants.filter(t => t.status === 'active').reduce((sum, t) => sum + (t.totalPending || 0), 0);
            
            document.getElementById('totalTenants').textContent = activeTenants;
            document.getElementById('vacantBeds').textContent = vacantBeds;
            document.getElementById('dueAmount').textContent = `‚Çπ${totalDue.toLocaleString()}`;
            document.getElementById('futureVacancies').textContent = '0'; // This would be calculated based on vacancy notices
        }

        // Show vacant beds details
        function showVacantBeds() {
            if (!currentSession.currentPG || !currentSession.currentPG.floorPlan) {
                alert('‚ö†Ô∏è No floor plan configured!\n\nPlease go to Rooms tab and configure your floor plan first.');
                return;
            }
            
            const vacantBedsContent = document.getElementById('vacantBedsContent');
            let vacantRooms = [];
            
            // Collect all vacant beds
            Object.keys(currentSession.currentPG.floorPlan.rooms).forEach(floorNumber => {
                currentSession.currentPG.floorPlan.rooms[floorNumber].forEach(room => {
                    const vacantCount = (room.beds || 0) - (room.occupied || 0);
                    if (vacantCount > 0) {
                        vacantRooms.push({
                            floor: floorNumber,
                            room: room.number,
                            sharing: room.sharing,
                            totalBeds: room.beds,
                            occupied: room.occupied || 0,
                            vacant: vacantCount,
                            feePerPerson: room.feePerPerson || getFeeBySharing(room.sharing)
                        });
                    }
                });
            });
            
            if (vacantRooms.length === 0) {
                vacantBedsContent.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üéâ</div>
                        <div class="text-lg font-semibold mb-2">All Beds Occupied!</div>
                        <div class="text-sm">Your PG is running at full capacity</div>
                    </div>
                `;
            } else {
                const totalVacant = vacantRooms.reduce((sum, room) => sum + room.vacant, 0);
                
                vacantBedsContent.innerHTML = `
                    <div class="mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-lg font-semibold text-blue-800">Total Vacant Beds</h4>
                                    <p class="text-sm text-blue-600">${vacantRooms.length} rooms with vacant beds</p>
                                </div>
                                <div class="text-3xl font-bold text-blue-600">${totalVacant}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${vacantRooms.map(room => `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-4">
                                            <div>
                                                <div class="font-semibold text-gray-800">Room ${room.room}</div>
                                                <div class="text-sm text-gray-600">Floor ${room.floor}</div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-600">Sharing Type</div>
                                                <div class="font-medium">${room.sharing.charAt(0).toUpperCase() + room.sharing.slice(1)}</div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-600">Occupancy</div>
                                                <div class="font-medium">${room.occupied}/${room.totalBeds}</div>
                                            </div>
                                            <div>
                                                <div class="text-sm text-gray-600">Fee per Person</div>
                                                <div class="font-medium text-green-600">‚Çπ${room.feePerPerson.toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-2xl font-bold text-blue-600">${room.vacant}</div>
                                        <div class="text-sm text-gray-600">vacant bed${room.vacant > 1 ? 's' : ''}</div>
                                        <button onclick="assignBedFromModal('${room.room}')" class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                            Assign Bed
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h5 class="font-semibold text-green-800 mb-2">üí° Quick Actions</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="closeModal('vacantBedsModal'); openModal('addTenantModal')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                                ‚ûï Add New Tenant
                            </button>
                            <button onclick="closeModal('vacantBedsModal'); document.querySelector('[data-tab=\"rooms\"]').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                üè† Manage Rooms
                            </button>
                        </div>
                    </div>
                `;
            }
            
            openModal('vacantBedsModal');
        }

        function assignBedFromModal(roomNumber) {
            closeModal('vacantBedsModal');
            // Pre-select the room in add tenant modal
            openModal('addTenantModal');
            
            // Find and select the room in the dropdown
            const roomSelect = document.getElementById('roomSelection');
            for (let option of roomSelect.options) {
                if (option.value.startsWith(roomNumber + '-')) {
                    roomSelect.value = option.value;
                    updateSharingTypeFromRoom();
                    break;
                }
            }
        }

        // Update sharing type and fee when room is selected
        function updateSharingTypeFromRoom() {
            const roomSelect = document.getElementById('roomSelection');
            const sharingTypeSelect = document.getElementById('sharingType');
            const feeAmountField = document.getElementById('feeAmount');
            
            if (roomSelect.value) {
                const selectedOption = roomSelect.options[roomSelect.selectedIndex];
                const sharingType = selectedOption.getAttribute('data-sharing');
                
                if (sharingType) {
                    // Update sharing type dropdown
                    sharingTypeSelect.value = sharingType;
                    
                    // Update fee amount
                    const dynamicFee = getFeeBySharing(sharingType);
                    feeAmountField.value = dynamicFee;
                    
                    // Show room and fee info
                    const roomInfo = document.createElement('div');
                    roomInfo.id = 'roomFeeInfo';
                    roomInfo.className = 'mt-2 p-3 bg-green-50 border border-green-200 rounded-lg';
                    roomInfo.innerHTML = `
                        <div class="text-sm text-green-700">
                            <strong>üè† Room Selected:</strong> ${selectedOption.textContent}<br>
                            <strong>üí∞ Monthly Fee:</strong> ‚Çπ${dynamicFee.toLocaleString()}<br>
                            <strong>üõèÔ∏è Sharing Type:</strong> ${sharingType.charAt(0).toUpperCase() + sharingType.slice(1)}
                        </div>
                    `;
                    
                    // Remove existing room info if present
                    const existingInfo = document.getElementById('roomFeeInfo');
                    if (existingInfo) {
                        existingInfo.remove();
                    }
                    
                    // Add new room info after the room selection field
                    roomSelect.parentNode.appendChild(roomInfo);
                    
                    // Recalculate first month fee if other fields are filled
                    calculateFirstMonthFee();
                }
            }
        }

        // Update fee based on sharing type selection
        function updateFeeBasedOnSharing() {
            const sharingType = document.getElementById('sharingType').value;
            const feeAmountField = document.getElementById('feeAmount');
            
            if (sharingType && feeAmountField) {
                const dynamicFee = getFeeBySharing(sharingType);
                feeAmountField.value = dynamicFee;
                
                // Show fee breakdown with sharing type info
                const feeInfo = document.createElement('div');
                feeInfo.id = 'sharingFeeInfo';
                feeInfo.className = 'mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg';
                feeInfo.innerHTML = `
                    <div class="text-sm text-blue-700">
                        <strong>üí∞ Fee Structure:</strong><br>
                        ‚Ä¢ Single Occupancy: ‚Çπ9,000/month<br>
                        ‚Ä¢ Double Sharing: ‚Çπ7,000/month<br>
                        ‚Ä¢ Triple Sharing: ‚Çπ6,000/month<br>
                        ‚Ä¢ Quad Sharing: ‚Çπ5,000/month<br><br>
                        <strong>Selected:</strong> ${sharingType.charAt(0).toUpperCase() + sharingType.slice(1)} - ‚Çπ${dynamicFee.toLocaleString()}/month
                    </div>
                `;
                
                // Remove existing fee info if present
                const existingInfo = document.getElementById('sharingFeeInfo');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                // Add new fee info after the fee amount field
                feeAmountField.parentNode.appendChild(feeInfo);
                
                // Recalculate first month fee if other fields are filled
                calculateFirstMonthFee();
            }
        }

        // Dynamic due date and fee calculation functions
        function updateDueDateOptions() {
            const joiningDate = new Date(document.getElementById('joiningDate').value);
            const dueDateSelect = document.getElementById('selectedDueDate');
            
            if (!joiningDate || isNaN(joiningDate)) {
                dueDateSelect.innerHTML = '<option value="">Select joining date first</option>';
                document.getElementById('feeBreakdown').style.display = 'none';
                return;
            }
            
            const joiningDay = joiningDate.getDate();
            dueDateSelect.innerHTML = '';
            
            // Add available due date options based on joining date
            if (joiningDay <= 25) { // If joined before 25th, can choose 1st or 5th of next month
                dueDateSelect.innerHTML = `
                    <option value="">Select due date</option>
                    <option value="1">1st of every month</option>
                    <option value="5">5th of every month</option>
                `;
            } else { // If joined after 25th, only next month's 1st or 5th available
                dueDateSelect.innerHTML = `
                    <option value="">Select due date</option>
                    <option value="1">1st of every month (Next month onwards)</option>
                    <option value="5">5th of every month (Next month onwards)</option>
                `;
            }
            
            // Clear fee breakdown when date changes
            document.getElementById('feeBreakdown').style.display = 'none';
        }
        
        function calculateFirstMonthFee() {
            const joiningDate = new Date(document.getElementById('joiningDate').value);
            const selectedDueDate = parseInt(document.getElementById('selectedDueDate').value);
            const monthlyFee = parseInt(document.getElementById('feeAmount').value) || 7000;
            
            if (!joiningDate || !selectedDueDate || isNaN(joiningDate)) {
                document.getElementById('feeBreakdown').style.display = 'none';
                return;
            }
            
            const joiningDay = joiningDate.getDate();
            const joiningMonth = joiningDate.getMonth();
            const joiningYear = joiningDate.getFullYear();
            
            let firstDueDate, daysToCharge, firstMonthFee;
            
            // Calculate first due date based on selection
            if (joiningDay <= selectedDueDate) {
                // If joined before or on due date, first due is same month
                firstDueDate = new Date(joiningYear, joiningMonth, selectedDueDate);
                daysToCharge = selectedDueDate - joiningDay + 1;
            } else {
                // If joined after due date, first due is next month
                firstDueDate = new Date(joiningYear, joiningMonth + 1, selectedDueDate);
                const daysInCurrentMonth = new Date(joiningYear, joiningMonth + 1, 0).getDate();
                const remainingDaysThisMonth = daysInCurrentMonth - joiningDay + 1;
                daysToCharge = remainingDaysThisMonth + selectedDueDate;
            }
            
            // Calculate prorated fee (max 30 days for calculation)
            firstMonthFee = Math.round((monthlyFee / 30) * Math.min(daysToCharge, 30));
            
            // Show breakdown
            const breakdownDiv = document.getElementById('feeCalculationDetails');
            const firstDueDateStr = firstDueDate.toLocaleDateString('en-IN', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            breakdownDiv.innerHTML = `
                <div><strong>Joining Date:</strong> ${joiningDate.toLocaleDateString('en-IN')}</div>
                <div><strong>Selected Due Date:</strong> ${selectedDueDate}${getOrdinalSuffix(selectedDueDate)} of every month</div>
                <div><strong>First Due Date:</strong> ${firstDueDateStr}</div>
                <div><strong>Days to charge:</strong> ${daysToCharge} days</div>
                <div><strong>Calculation:</strong> ‚Çπ${monthlyFee} √∑ 30 days √ó ${Math.min(daysToCharge, 30)} days</div>
                <div class="font-semibold text-blue-800"><strong>First Month Fee:</strong> ‚Çπ${firstMonthFee}</div>
                <div class="text-xs mt-2 text-blue-600">
                    <em>From ${firstDueDateStr} onwards, regular monthly fee of ‚Çπ${monthlyFee} will be charged on ${selectedDueDate}${getOrdinalSuffix(selectedDueDate)} of every month.</em>
                </div>
            `;
            
            document.getElementById('feeBreakdown').style.display = 'block';
        }
        
        function getOrdinalSuffix(day) {
            if (day >= 11 && day <= 13) return 'th';
            switch (day % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        // Form submissions
        document.getElementById('addTenantForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate phone number
            const phone = document.getElementById('tenantPhone').value;
            if (!/^\d{10}$/.test(phone)) {
                alert('Phone number must be exactly 10 digits');
                return;
            }
            
            // Validate Aadhar number
            const aadhar = document.getElementById('tenantAadhar').value;
            if (!/^\d{12}$/.test(aadhar)) {
                alert('Aadhar number must be exactly 12 digits');
                return;
            }
            
            // Validate due date selection
            const selectedDueDate = parseInt(document.getElementById('selectedDueDate').value);
            if (!selectedDueDate) {
                alert('Please select a due date');
                return;
            }
            
            // Calculate prorated amount for first month using the new logic
            const joiningDate = new Date(document.getElementById('joiningDate').value);
            const monthlyFee = parseInt(document.getElementById('feeAmount').value);
            const joiningDay = joiningDate.getDate();
            const joiningMonth = joiningDate.getMonth();
            const joiningYear = joiningDate.getFullYear();
            
            let firstDueDate, daysToCharge, firstMonthFee;
            
            if (joiningDay <= selectedDueDate) {
                firstDueDate = new Date(joiningYear, joiningMonth, selectedDueDate);
                daysToCharge = selectedDueDate - joiningDay + 1;
            } else {
                firstDueDate = new Date(joiningYear, joiningMonth + 1, selectedDueDate);
                const daysInCurrentMonth = new Date(joiningYear, joiningMonth + 1, 0).getDate();
                const remainingDaysThisMonth = daysInCurrentMonth - joiningDay + 1;
                daysToCharge = remainingDaysThisMonth + selectedDueDate;
            }
            
            firstMonthFee = Math.round((monthlyFee / 30) * Math.min(daysToCharge, 30));
            
            // Handle Aadhar image encryption
            let encryptedAadharImage = null;
            const aadharFile = document.getElementById('aadharImage').files[0];
            if (aadharFile) {
                try {
                    encryptedAadharImage = await AadharEncryption.encryptFile(aadharFile);
                    console.log('‚úÖ Aadhar image encrypted successfully');
                } catch (error) {
                    console.error('‚ùå Aadhar encryption failed:', error);
                    alert('Failed to encrypt Aadhar image. Please try again.');
                    return;
                }
            }
            
            const newTenant = {
                id: tenants.length + 1,
                name: document.getElementById('tenantName').value,
                phone: phone,
                aadhar: aadhar,
                fatherName: document.getElementById('fatherName').value,
                parentPhone: document.getElementById('parentPhone').value,
                room: document.getElementById('roomSelection').value.split('-')[0],
                bed: document.getElementById('roomSelection').value.split('-')[1],
                sharingType: document.getElementById('sharingType').value,
                joiningDate: document.getElementById('joiningDate').value,
                dueDate: selectedDueDate,
                monthlyFee: monthlyFee,
                advanceAmount: parseInt(document.getElementById('advanceAmount').value),
                paidAmount: 0,
                remainingAmount: firstMonthFee,
                status: 'active',
                officeName: document.getElementById('officeName').value,
                officeAddress: document.getElementById('officeAddress').value,
                firstDueDate: firstDueDate.toISOString().split('T')[0],
                daysCharged: daysToCharge,
                firstMonthFee: firstMonthFee
            };
            
            tenants.push(newTenant);
            
            // Save encrypted Aadhar image to database
            if (encryptedAadharImage) {
                try {
                    await DatabaseManager.saveAadharImage(newTenant.id, encryptedAadharImage);
                    console.log('‚úÖ Encrypted Aadhar image saved to database');
                } catch (error) {
                    console.error('‚ùå Failed to save encrypted image:', error);
                }
            }
            
            // Real-time save to database
            try {
                await DatabaseManager.saveData('tenants', newTenant);
                console.log('‚úÖ Tenant saved to database in real-time');
            } catch (error) {
                console.error('‚ùå Failed to save tenant:', error);
            }
            
            loadTenants();
            updateDashboardStats();
            closeModal('addTenantModal');
            
            alert(`Tenant added successfully!\nFirst month fee: ‚Çπ${firstMonthFee}\nFirst due date: ${firstDueDate.toLocaleDateString('en-IN')}\nRegular due date: ${selectedDueDate}${getOrdinalSuffix(selectedDueDate)} of every month`);
        });

        document.getElementById('addPaymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tenantId = parseInt(document.getElementById('paymentTenant').value.replace('tenant', ''));
            const amount = parseInt(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const tenant = tenants.find(t => t.id === tenantId);
            
            if (tenant) {
                const newPayment = {
                    id: payments.length + 1,
                    tenantId: tenantId,
                    amount: amount,
                    date: paymentDate,
                    type: document.getElementById('paymentType').value,
                    status: 'completed'
                };
                
                payments.push(newPayment);
                
                // Update tenant's monthly dues with smart payment allocation
                let remainingAmount = amount;
                let paymentBreakdown = [];
                
                // Initialize monthlyDues if not exists
                if (!tenant.monthlyDues) {
                    tenant.monthlyDues = [];
                }
                
                // Sort dues by date (oldest first) to pay in chronological order
                tenant.monthlyDues.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
                
                // Allocate payment to pending/partial dues first
                for (let due of tenant.monthlyDues) {
                    if (remainingAmount <= 0) break;
                    
                    if (due.status === 'pending' || due.status === 'overdue' || due.status === 'partial') {
                        const amountToPay = Math.min(remainingAmount, due.pendingAmount);
                        due.paidAmount += amountToPay;
                        due.pendingAmount -= amountToPay;
                        remainingAmount -= amountToPay;
                        
                        // Update status
                        if (due.pendingAmount === 0) {
                            due.status = 'paid';
                        } else {
                            due.status = 'partial';
                        }
                        
                        paymentBreakdown.push({
                            month: new Date(due.month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }),
                            amount: amountToPay,
                            remaining: due.pendingAmount
                        });
                    }
                }
                
                // If there's still remaining amount, it becomes advance
                let advanceAmount = remainingAmount;
                
                // Recalculate total pending
                tenant.totalPending = tenant.monthlyDues.reduce((sum, due) => sum + due.pendingAmount, 0);
                tenant.lastPaymentDate = paymentDate;
                
                loadPayments();
                loadTenants();
                updateDashboardStats();
                closeModal('addPaymentModal');
                
                // Show detailed payment allocation
                let allocationMessage = `üí∞ PAYMENT ALLOCATED SUCCESSFULLY!\n\nTotal Payment: ‚Çπ${amount}\n\nüìã ALLOCATION BREAKDOWN:\n`;
                paymentBreakdown.forEach(item => {
                    allocationMessage += `‚Ä¢ ${item.month}: ‚Çπ${item.amount}`;
                    if (item.remaining > 0) {
                        allocationMessage += ` (‚Çπ${item.remaining} still pending)`;
                    } else {
                        allocationMessage += ` (‚úÖ PAID)`;
                    }
                    allocationMessage += `\n`;
                });
                
                if (advanceAmount > 0) {
                    allocationMessage += `\nüí≥ Advance Amount: ‚Çπ${advanceAmount}`;
                }
                
                allocationMessage += `\n\nüìä SUMMARY:\n‚Ä¢ Total Pending After Payment: ‚Çπ${tenant.totalPending}\n‚Ä¢ Payment Date: ${new Date(paymentDate).toLocaleDateString('en-IN')}`;
                
                alert(allocationMessage);
            }
        });

        document.getElementById('vacancyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const tenantId = parseInt(document.getElementById('vacancyTenant').value.replace('tenant', ''));
            const tenant = tenants.find(t => t.id === tenantId);
            const vacancyType = document.getElementById('vacancyType').value;
            const advanceAmount = tenant.advanceAmount;
            const maintenanceDeduction = 1000; // From settings
            const advanceReturn = vacancyType === 'future' ? advanceAmount - maintenanceDeduction : 0;
            
            if (tenant) {
                tenant.status = 'vacated';
                tenant.vacancyDate = document.getElementById('vacancyDate').value;
                tenant.advanceReturn = advanceReturn;
                
                // Update room occupancy
                Object.values(floorPlan.rooms).flat().forEach(room => {
                    if (room.number === tenant.room) {
                        room.occupied = Math.max(0, room.occupied - 1);
                    }
                });
                
                loadTenants();
                generateFloorPlan();
                updateDashboardStats();
                closeModal('vacancyModal');
                
                alert(`Vacancy marked successfully! Advance return amount: ‚Çπ${advanceReturn}`);
            }
        });

        // Search functionality
        function searchTenants() {
            const searchTerm = document.getElementById('tenantSearch').value.toLowerCase();
            const filter = document.getElementById('tenantFilter').value;
            
            let filteredTenants = tenants;
            
            // Apply status filter
            if (filter !== 'all') {
                if (filter === 'due') {
                    filteredTenants = filteredTenants.filter(t => t.remainingAmount > 0);
                } else {
                    filteredTenants = filteredTenants.filter(t => t.status === filter);
                }
            }
            
            // Apply search filter
            if (searchTerm) {
                filteredTenants = filteredTenants.filter(t => 
                    t.name.toLowerCase().includes(searchTerm) ||
                    t.phone.includes(searchTerm) ||
                    t.aadhar.includes(searchTerm)
                );
            }
            
            // Update table with filtered results
            const tbody = document.getElementById('tenantsTableBody');
            tbody.innerHTML = '';
            
            filteredTenants.forEach(tenant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold">
                                    ${tenant.name.charAt(0)}
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${tenant.name}</div>
                                <div class="text-sm text-gray-500">${tenant.phone}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">Room ${tenant.room}</div>
                        <div class="text-sm text-gray-500">${tenant.sharingType} sharing</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${tenant.dueDate}th of every month</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium ${tenant.totalPending > 0 ? 'text-red-600' : 'text-green-600'}">
                            ‚Çπ${tenant.totalPending || 0}
                        </div>
                        <div class="text-xs text-gray-500">
                            ${tenant.monthlyDues ? tenant.monthlyDues.filter(d => d.status === 'pending' || d.status === 'overdue' || d.status === 'partial').length : 0} months pending
                        </div>
                        ${tenant.lastPaymentDate ? `<div class="text-xs text-blue-500">Last paid: ${new Date(tenant.lastPaymentDate).toLocaleDateString('en-IN')}</div>` : '<div class="text-xs text-red-500">No payments yet</div>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${tenant.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${tenant.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewTenant(${tenant.id})" class="text-indigo-600 hover:text-indigo-900 mr-2">View</button>
                        <button onclick="viewAadharImage(${tenant.id})" class="text-green-600 hover:text-green-900 mr-2" title="View Aadhar (Encrypted)">üîì</button>
                        <button onclick="editTenant(${tenant.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                        <button onclick="markVacancy(${tenant.id})" class="text-red-600 hover:text-red-900">Vacate</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Report functions
        function generateMonthlyReport() {
            const reportMonth = document.getElementById('reportMonth').value;
            const [year, month] = reportMonth.split('-');
            const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const activeTenants = tenants.filter(t => t.status === 'active');
            
            let reportHTML = `
                <div class="space-y-4">
                    <h4 class="text-lg font-bold text-gray-800">Monthly Report - ${monthName}</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Room</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monthly Fee</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Balance</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${activeTenants.map(tenant => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tenant.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tenant.room}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tenant.phone}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${tenant.dueDate}th</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">‚Çπ${tenant.monthlyFee}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm ${tenant.remainingAmount > 0 ? 'text-red-600' : 'text-green-600'}">‚Çπ${tenant.remainingAmount}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-indigo-600">${activeTenants.length}</div>
                                <div class="text-sm text-gray-600">Active Tenants</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600">‚Çπ${activeTenants.reduce((sum, t) => sum + t.monthlyFee, 0).toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Expected Revenue</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-yellow-600">‚Çπ${activeTenants.reduce((sum, t) => sum + t.remainingAmount, 0).toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Pending Amount</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-blue-600">‚Çπ${activeTenants.reduce((sum, t) => sum + (t.monthlyFee - t.remainingAmount), 0).toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Collected Amount</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportTitle').textContent = `Monthly Report - ${monthName}`;
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('reportDisplay').style.display = 'block';
        }

        function showVacancyList(type) {
            let title, content;
            
            if (type === 'current') {
                const vacantRooms = Object.values(floorPlan.rooms).flat().filter(room => room.occupied < room.beds);
                title = 'Current Vacancies';
                content = `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${vacantRooms.map(room => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="text-lg font-semibold">Room ${room.number}</div>
                                <div class="text-sm text-gray-600">${room.sharing} sharing</div>
                                <div class="text-sm text-gray-600">${room.beds - room.occupied} beds available</div>
                                <button onclick="assignBed('${room.number}')" class="mt-2 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    Assign Bed
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (type === 'future') {
                title = 'Future Vacancies';
                content = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üìÖ</div>
                        <div>No future vacancy notices received</div>
                    </div>
                `;
            } else {
                const vacatedTenants = tenants.filter(t => t.status === 'vacated');
                title = 'Vacancy History';
                content = `
                    <div class="space-y-4">
                        ${vacatedTenants.map(tenant => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-semibold">${tenant.name}</div>
                                        <div class="text-sm text-gray-600">Room ${tenant.room}</div>
                                        <div class="text-sm text-gray-600">Vacated: ${tenant.vacancyDate || 'N/A'}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm text-gray-600">Advance Return</div>
                                        <div class="font-semibold text-green-600">‚Çπ${tenant.advanceReturn || 0}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportContent').innerHTML = content;
            document.getElementById('reportDisplay').style.display = 'block';
        }

        function closeReport() {
            document.getElementById('reportDisplay').style.display = 'none';
        }

        function downloadReport() {
            alert('Report download functionality would be implemented with a backend service. For now, you can print this page or copy the data.');
        }

        // View encrypted Aadhar image
        async function viewAadharImage(tenantId) {
            try {
                const imageData = await DatabaseManager.getAadharImage(tenantId);
                if (imageData && imageData.encryptedImage) {
                    const decryptedImage = AadharEncryption.decryptToViewable(imageData.encryptedImage);
                    
                    // Create modal to display image
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-2xl max-h-screen overflow-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">üîì Aadhar Document (Decrypted)</h3>
                                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                            </div>
                            <img src="${decryptedImage}" alt="Aadhar Document" class="max-w-full h-auto rounded-lg border">
                            <div class="mt-4 text-center">
                                <button onclick="downloadAadharImage(${tenantId})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 mr-2">
                                    üì• Download
                                </button>
                                <button onclick="this.closest('.fixed').remove()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                                    Close
                                </button>
                            </div>
                            <div class="mt-2 text-xs text-green-600 text-center">
                                üîê This document was securely encrypted and is now temporarily decrypted for viewing
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } else {
                    alert('‚ùå No Aadhar image found for this tenant');
                }
            } catch (error) {
                console.error('Failed to decrypt Aadhar image:', error);
                alert('‚ùå Failed to decrypt Aadhar image. Please try again.');
            }
        }

        // Download encrypted Aadhar image
        async function downloadAadharImage(tenantId) {
            try {
                const imageData = await DatabaseManager.getAadharImage(tenantId);
                if (imageData && imageData.encryptedImage) {
                    const decryptedImage = AadharEncryption.decryptToViewable(imageData.encryptedImage);
                    const tenant = tenants.find(t => t.id === tenantId);
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = decryptedImage;
                    link.download = `${tenant ? tenant.name : 'tenant'}_aadhar_${new Date().toISOString().split('T')[0]}.jpg`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('üì• Aadhar image downloaded successfully!\n\nüîê Note: The downloaded image is decrypted for your use.');
                } else {
                    alert('‚ùå No Aadhar image found for download');
                }
            } catch (error) {
                console.error('Failed to download Aadhar image:', error);
                alert('‚ùå Failed to download Aadhar image. Please try again.');
            }
        }

        // Utility functions
        function viewTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (tenant) {
                let monthlyBreakdown = '';
                if (tenant.monthlyDues && tenant.monthlyDues.length > 0) {
                    monthlyBreakdown = `\n\nüìÖ MONTHLY PAYMENT BREAKDOWN:\n`;
                    tenant.monthlyDues.forEach(due => {
                        const monthName = new Date(due.month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
                        const statusIcon = due.status === 'paid' ? '‚úÖ' : due.status === 'partial' ? 'üü°' : due.status === 'overdue' ? 'üî¥' : '‚è≥';
                        monthlyBreakdown += `${statusIcon} ${monthName}: ‚Çπ${due.amount} (${due.status.toUpperCase()})\n`;
                        if (due.status === 'partial') {
                            monthlyBreakdown += `   üí∞ Paid: ‚Çπ${due.paidAmount} | Pending: ‚Çπ${due.pendingAmount}\n`;
                        } else if (due.status === 'pending' || due.status === 'overdue') {
                            monthlyBreakdown += `   ‚ö†Ô∏è Full amount pending: ‚Çπ${due.pendingAmount}\n`;
                        }
                        monthlyBreakdown += `   üìÖ Due Date: ${new Date(due.dueDate).toLocaleDateString('en-IN')}\n\n`;
                    });
                    
                    monthlyBreakdown += `üí∏ TOTAL PENDING: ‚Çπ${tenant.totalPending || 0}\n`;
                    if (tenant.lastPaymentDate) {
                        monthlyBreakdown += `üóìÔ∏è Last Payment: ${new Date(tenant.lastPaymentDate).toLocaleDateString('en-IN')}`;
                    } else {
                        monthlyBreakdown += `‚ùå No payments received yet`;
                    }
                }

                let initialFeeBreakdown = '';
                if (tenant.feeBreakdown) {
                    initialFeeBreakdown = `\n\nüè† INITIAL FEE CALCULATION:\n` +
                                        `‚Ä¢ Joining Date: ${new Date(tenant.joiningDate).toLocaleDateString('en-IN')}\n` +
                                        `‚Ä¢ Selected Due Date: ${tenant.dueDate}${getOrdinalSuffix(tenant.dueDate)} of every month\n` +
                                        `‚Ä¢ First Due Date: ${new Date(tenant.firstDueDate).toLocaleDateString('en-IN')}\n` +
                                        `‚Ä¢ Days Charged: ${tenant.daysCharged} days\n` +
                                        `‚Ä¢ Calculation: ${tenant.feeBreakdown.calculation}\n` +
                                        `‚Ä¢ First Month Fee: ‚Çπ${tenant.firstMonthFee}\n\n` +
                                        `üìù ${tenant.feeBreakdown.note}`;
                }
                
                alert(`üë§ TENANT DETAILS:\n` +
                      `Name: ${tenant.name}\n` +
                      `Phone: ${tenant.phone}\n` +
                      `Room: ${tenant.room} (${tenant.sharingType} sharing)\n` +
                      `Joining Date: ${new Date(tenant.joiningDate).toLocaleDateString('en-IN')}\n` +
                      `Monthly Fee: ‚Çπ${tenant.monthlyFee}\n` +
                      `Due Date: ${tenant.dueDate}${getOrdinalSuffix(tenant.dueDate)} of every month\n` +
                      `Status: ${tenant.status.toUpperCase()}` +
                      initialFeeBreakdown +
                      monthlyBreakdown);
            }
        }

        function editTenant(id) {
            alert('Edit tenant functionality would open a form similar to Add Tenant with pre-filled data.');
        }

        function markVacancy(id) {
            document.getElementById('vacancyTenant').value = `tenant${id}`;
            openModal('vacancyModal');
        }

        function assignBed(roomNumber) {
            alert(`Assign bed functionality would open the Add Tenant form with Room ${roomNumber} pre-selected.`);
        }

        function saveSettings() {
            // Update fee structure from settings
            feeStructure.single = parseInt(document.getElementById('singleFee').value) || 9000;
            feeStructure.double = parseInt(document.getElementById('doubleFee').value) || 7000;
            feeStructure.triple = parseInt(document.getElementById('tripleFee').value) || 6000;
            feeStructure.quad = parseInt(document.getElementById('quadFee').value) || 5000;
            
            // Save to localStorage for persistence
            localStorage.setItem('pgFeeStructure', JSON.stringify(feeStructure));
            
            alert(`üíæ SETTINGS SAVED SUCCESSFULLY!\n\nüí∞ Updated Fee Structure:\n‚Ä¢ Single Occupancy: ‚Çπ${feeStructure.single.toLocaleString()}/month\n‚Ä¢ Double Sharing: ‚Çπ${feeStructure.double.toLocaleString()}/month\n‚Ä¢ Triple Sharing: ‚Çπ${feeStructure.triple.toLocaleString()}/month\n‚Ä¢ Quad Sharing: ‚Çπ${feeStructure.quad.toLocaleString()}/month\n\n‚úÖ New fees will apply to future tenant additions.`);
        }

        function previousPage() {
            alert('Previous page functionality would be implemented with proper pagination.');
        }

        function nextPage() {
            alert('Next page functionality would be implemented with proper pagination.');
        }

        // Auto-generate monthly dues (would run as a scheduled task)
        function generateMonthlyDues() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            
            tenants.filter(t => t.status === 'active').forEach(tenant => {
                if (!tenant.monthlyDues) {
                    tenant.monthlyDues = [];
                }
                
                // Generate dues for current month if due date has passed and not already generated
                const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const dueDate = new Date(currentYear, currentMonth, tenant.dueDate);
                
                // Check if current month's due already exists
                const existingDue = tenant.monthlyDues.find(due => due.month === currentMonthKey);
                
                if (today >= dueDate && !existingDue) {
                    // Generate new monthly due
                    const newDue = {
                        month: currentMonthKey,
                        amount: tenant.monthlyFee,
                        dueDate: dueDate.toISOString().split('T')[0],
                        status: 'pending',
                        paidAmount: 0,
                        pendingAmount: tenant.monthlyFee
                    };
                    
                    tenant.monthlyDues.push(newDue);
                    
                    // Recalculate total pending
                    tenant.totalPending = tenant.monthlyDues.reduce((sum, due) => sum + due.pendingAmount, 0);
                }
                
                // Update overdue status for past dues
                tenant.monthlyDues.forEach(due => {
                    const dueDateObj = new Date(due.dueDate);
                    if (today > dueDateObj && (due.status === 'pending' || due.status === 'partial')) {
                        due.status = due.paidAmount > 0 ? 'partial' : 'overdue';
                    }
                });
            });
            
            // Update displays
            loadTenants();
            updateDashboardStats();
            loadUpcomingDues();
        }

        // Function to manually generate next month's dues (for testing)
        function generateNextMonthDues() {
            const today = new Date();
            const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1, 1);
            const nextMonthKey = `${nextMonth.getFullYear()}-${String(nextMonth.getMonth() + 1).padStart(2, '0')}`;
            
            tenants.filter(t => t.status === 'active').forEach(tenant => {
                if (!tenant.monthlyDues) {
                    tenant.monthlyDues = [];
                }
                
                // Check if next month's due already exists
                const existingDue = tenant.monthlyDues.find(due => due.month === nextMonthKey);
                
                if (!existingDue) {
                    const dueDate = new Date(nextMonth.getFullYear(), nextMonth.getMonth(), tenant.dueDate);
                    const newDue = {
                        month: nextMonthKey,
                        amount: tenant.monthlyFee,
                        dueDate: dueDate.toISOString().split('T')[0],
                        status: 'pending',
                        paidAmount: 0,
                        pendingAmount: tenant.monthlyFee
                    };
                    
                    tenant.monthlyDues.push(newDue);
                    tenant.totalPending = tenant.monthlyDues.reduce((sum, due) => sum + due.pendingAmount, 0);
                }
            });
            
            loadTenants();
            updateDashboardStats();
            alert('Next month dues generated successfully!');
        }

        // This would be called daily by a scheduler
        setInterval(generateMonthlyDues, 24 * 60 * 60 * 1000); // Check daily
        
        // Run once on page load to ensure current month dues are generated
        generateMonthlyDues();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'965bc65e646a897b',t:'MTc1MzYxNTUxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
